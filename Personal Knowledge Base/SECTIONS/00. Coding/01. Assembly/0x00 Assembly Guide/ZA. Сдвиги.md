Сдвиги — это особые операции процессора, которые позволяют реализовать различные преобразования данных, работать с отдельными битами, а также быстро выполнять умножение и деление чисел на степень 2. В этой части мы рассмотрим операции линейного сдвига, а в следующей будут циклические. Или же другими словами команды сдвига выполняют перемещения битов в байте на соседнее место влево или вправо. Существуют два типа сдвигов - сдвиг логический и сдвиг арифметический. При логическом сдвиге байт рассматривается как набор из восьми двоичных знаков (0 или1). При арифметическом сдвиге содержимое рассматривается как число со знаком.

В процессорах 8086 имеется множество способов, с помощью которых  можно сдвигать биты регистра или переменной в памяти влево
или вправо. Простейшим из них является логический сдвиг.




# Инструкция SHL/SAL


Инструкция SHL (сдвиг влево, синоним - SAL) перемещает  каждый бит операнда-приемника на один разряд влево, по направлению к самому  значащему  биту.  На  Рис.  5.8  показано,  как  значение 100010110b (96h или 150 в десятичном представлении), записанное в AL, сдвигается влево с помощью инструкции SHL AL,1. В  результате получается  значение  00101100b  (24Ch или 44 в десятичном виде),
которое записывается обратно в регистр AL. Флаг переноса устанавливается в значение 1.

         AL
   ------------------------------
      | -----  -----  -----  -----  -----  -----  -----  ----- ----    |
 --- | | 1 |<-| 0 |<-| 0 |<-| 1 |<-| 0 |<-| 1 |<-| 1 |<-| 0 |  |<-----------------
|    | -----  -----  -----  -----  -----  -----  -----  -----  -----   |                      |
|    ------------------------------------------------------                                 |
| Бит  7      6      5      4      3      2      1      0                                   |
|          -----                                                                                      |
 ---->|          |                                         0 -------------- —————---
           -----
 Флаг переноса

     Рис. 5.8 Пример выполнения сдвига влево.

     Самый значащий (старший) бит вовсе сдвигается из  операнда и попадает во флаг переноса, а в наименее значащий бит заносится 0.

Для чего используется сдвиг влево? Чаще всего  это  делается для  выполнения с помощью операции SHL умножения на степень числа 2, так как каждая инструкция SHL умножает операнд на 2. Например, с помощью следующих инструкций DX умножается на 16:


```
           .
           .
           .
           shl   dx,1   ; DX * 2
           shl   dx,1   ; DX * 4
           shl   dx,1   ; DX * 8
           shl   dx,1   ; DX * 16
           .
           .
           .
```
	 
Умножение с помощью сдвига выполняется гораздо быстрее,  чем с помощью операции MUL.

Как вы могли заметить, в предыдущем примере в инструкции SHL используется второй операнд - значение 1. Этот операнд указывает, что содержимое DX нужно сдвинуть на 1 бит. К сожалению, процессор 8086  не  поддерживает  использования в качестве константы сдвига других, отличных от 1 постоянных значений - 2, 3 и т.д. Однако, в качестве  счетчика сдвигов допускается использование регистра CL.
Например, инструкции:


```
           .
           .
           .
           mov   cl,4
           shl   dx,cl
           .
           .
           .

```

умножают содержимое  регистра DX на 16 (как и в предыдущем примере).

Если есть сдвиг влево, то логично было бы предположить,  что существует  также  сдвиг  вправо,  и это так. Фактически, имеется даже две операции сдвига вправо. Инструкция  SHR  (сдвиг  вправо) очень похожа на инструкцию SHL. Она выполняет сдвиг разрядов операнда  вправо  на 1 или CL бит,  затем сдвигает наименее значащий бит во флаг переноса и помещает 0 в самый значащий бит.  Инструкция  SHR  дает  быстрый способ выполнения беззнакового деления на степень числа 2.

Логический сдвиг влево выполняется командой SHL, а арифметический — командой SAL. Однако, на самом деле это просто синонимы для одной и той же машинной команды. Сдвиг влево одинаков для чисел со знаком и чисел без знака. У команды 2 операнда, аналогично командам SHR и SAR. Схема этой операции показана на рисунке:

![[Pasted image 20221006150011.png]]

Старший бит становится значением флага CF, а младший получает нулевое значение. С помощью сдвига влево можно быстро умножать числа на степень 2. Но будьте внимательны, чтобы не получить в результате переполнение. Если при сдвиге на 1 бит меняется значение старшего бита, то устанавливается флаг OF. Примеры использования команды:


```
shl dx,1  ;Сдвиг DX на 1 бит влево
sal dx,1  ;То же самое
shl ax,cl ;Сдвиг AX на CL бит влево
sal [x],2 ;x = x * 4

```



# Инструкция  SAR

Инструкция SAR выпонлняет сдвиг вправо. Этот иснтрукция сдвигает все биты оперенда вправо на один разряд, при этом выдвигаемая справа бит становится значением флага переноса (CF).Младший бит
операнда поступает в флаг CF. Если команда записана в формате:

>sar операнд,1

Cдвиг осуществляется на 1 бит. Старший бит операнда сохраняет свое значение то есть не меняется (наиболее значащий бит операнда сдвигается вправо в следующий бит, а затем копируется обратно).
Если команда записана в формате:

>sar операнд,CL


Инструкция  SAR  (арифметический  сдвиг  вправо)  аналогична инструкции  SHR,  только  при ее выполнении наиболее значащий бит операнда сдвигается вправо в следующий бит,  а  затем  копируется 
обратно.  На  Рис.  5.9 показано, как значение 10010110b (96h или -106 в десятичном представлении со знаком), записанное в регистре AL, сдвигается вправо с помощью инструкции SAR AL,1. В результате
получается значение 11001011b (0CBh или -53 в  десятичном  представлении  со  знаком), которое записывается обратно в регистр AL. Флаг переноса устанавливается в значение 0.


                              AL

-------------------------------------------------------  |
|   ------                                                         |
|   |     |                                                         |
|   V   |                                                          |
| -----  | -----  -----  -----  -----  -----  -----  -----   |
| | 1 |<---| 0 |<-| 0 |<-| 1 |<-| 0 |<-| 1 |<-| 1 |<-| 0 |   |<--
| -----    -----  -----  -----  -----  -----  -----  -----   |             |
----------------------------------------------------------             |
  Бит  7      6      5      4      3      2      1      0              |
                                                     -----                       |
                                                   |        |-----------------
                                                     -----
                                             Флаг переноса

     Рис. 5.9 Пример выполнения  инструкции  SAR  (арифметический сдвиг вправо).

Таким образом, при выполнении данной инструкции  сохраняется знак  операнда,  поэтому  инструкцию SAR полезно использовать для
выполнения деления со знаком на степень числа 2. Например, в  результате выполнения инструкций:


```
           .
           .
           .
           mov   bx,-4
           sar   bx,1
           .
           .
           .

```

в регистре BX будет записано значение -2.

11111011 CF = ?
SAR →
11111101 CF = 1

Арифметический сдвиг отличается от логического тем, что он не изменяет значение старшего бита, и предназначен для чисел со знаком. Арифметический сдвиг вправо выполняется командой SAR. У этой команды тоже 2 операнда, аналогично команде SHR. Схема выполнения операции показана на рисунке:

![[Pasted image 20221006151522.png]]

Выдвинутый бит становится значением флага CF. Знаковый бит не изменяется. При сдвиге на 1 бит сбрасывается флаг OF. Эту команду можно использовать для деления целых чисел со знаком на степень 2 (обратите внимание, что «округление» всегда в сторону меньшего числа, поэтому для отрицательных чисел результат будет отличаться от результата деления с помощью команды  IDIV ). Примеры:


```
sar bx,1  ;Арифметический сдвиг BX на 1 бит вправо
sar di,cl ;Арифметический сдвиг DI на CL бит вправо
sar [x],3 ;x = x / 8 (x - 8-битное значение со знаком)

```



# Инструкция SHR

Команда shr осуществляет сдвиг вправо всех битов операнда.Проще говоря, Сдвиньте вправо. Второй операнд определяет количество битов, которые должны быть сдвинуты вправо. Так:
>
>CL = 42(в hex) = 0100 0010 (двоичный)

Сдвиг вправо один раз, все биты идут правильно. Самый младший значащий бит(самый правый) переходит к флагу переноса (CF), а к самому старшему значащему биту (самому левому) добавляется ноль. Таким образом, значение становится :

>0010 0001 (21 в hex) -> и крайний правый 0 переходит к флагу переноса.

Вот это и значит - быстрое умножение/деление на степень двойки. По сравнению с mul/div, команды выполняются в районе десятка тактов процессора, против сотни последних.
Так они быстро делают умножение и деление на степени двойки, и употребляют меньше такотов процессора. Ещё используют для доступа к старшим частям 32 и 64 разрядных регистров - к котором нет прямого обращения.

Логический сдвиг всегда выполняется без учёта знакового бита. Для логического сдвига вправо предназначена команда SHR. У этой команды два операнда. Первый операнд представляет собой сдвигаемое значение и на его место записывается результат операции. Второй операнд указывает, на сколько бит нужно осуществить сдвиг. Этим операндом может быть либо непосредственное значение, либо регистр CL. Схема выполнения операции показана на рисунке:

![[Pasted image 20221006152114.png]]

Все биты операнда сдвигаются вправо (от старших битов к младшим). Выдвинутый бит становится значением флага CF. Старший бит получает нулевое значение. Эта операция повторяется несколько раз, если второй операнд больше единицы. Логический сдвиг вправо можно использовать для деления целых чисел без знака на степень 2, причём сдвиг работает быстрее, чем команда деления DIV. Примеры:


```
shr ax,1 ;Логический сдвиг AX на 1 бит вправо
shr byte[bx],cl ;Лог. сдвиг байта по адресу BX на СL бит вправо
shr cl,4 ;CL = CL / 16 (для числа без знака)

```




# Инструкция SHRD/SHLD

Существуют ещё две команды, осуществляющие более сложные сдвиги. SHRD — сдвиг двойной точности вправо, SHLD — сдвиг двойной точности влево. У этих команд 3 операнда. Первый операнд — сдвигаемое значение и место для записи результата, должен иметь размер 16 бит. Второй операнд — источник вдвигаемых битов, тоже должен иметь размер 16 бит и находится в одном из регистров. Значение второго операнда не меняется. Третий операнд — счётчик сдвигов, может быть непосредственным значением или находиться в регистре CL. Схемы работы этих команд показаны на рисунке:

![[Pasted image 20221006152446.png]]


Небольшой пример использования команды SHLD:

>
shld ax, bx,3 ;Сдвинуть ax на 3 бита влево,
                     ;3 старших бита BX становятся младшими битами AX








В наборе инструкций процессора  8086  имеется  также  четыре инструкции  циклического  сдвига: ROR, ROL, RCR и RCL. Инструкция ROR аналогична  инструкции  SHR,  но  при  ее выполнении наименее значащий бит сдвигается в наиболее значащий бит,  а также во флаг переноса.  На Рис. 5.10 показано, как значение 10010110b (96h или 159  в  десятичном  представлении),  записанное  в  регистре  AL,
циклически  сдвигается  вправо  с помощью инструкции ROR AL,1.  В результате  получается  значение  01001011b  (04Bh или  75  в десятичном представлении), которое записывается обратно в регистр AL. Флаг переноса устанавливается в значение 0.

    AL
       ----------------------------------------------------------
      | -----  -----  -----  -----  -----  -----  -----  ----- |
  -->| | 1 |->| 0 |->| 0 |->| 1 |->| 0 |->| 1 |->| 1 |->| 0 |  |---
|     |   -----  -----  -----  -----  -----  -----  -----  ----- |          |
|     ----------------------------------------------------------        |
| Бит  7      6      5      4      3      2      1      0               |
|                                                                                  |
    ------------------------------------------------------------------|
                                                                   -----          |
                                Флаг переноса         |        |<----
                                                                   -----
      Рис. 5.10 Пример выполнения операции ROR (циклический сдвиг
вправо).

Операция ROL имеет  действие,  обратное  действию  операции ROR. Операнд также сдвигается циклически,  но  сдвиг  выполняется влево. При этом наиболее значащий бит сдвигается в наименее  значащий.  Инструкции ROR и ROL полезно использовать для  переупорядочивания бит в байте или в слове.  Например, в результате выполнения инструкций:


```
           .
           .
           .
           mov   si,49F1h
           mov   cl,4
           ror   si,cl
           .
           .
           .

```

в регистр SI будет записано значение 149Fh: биты 3-0 переместятся в биты 15-12, биты 7-4 - в биты 3-0 и т.д.

Инструкции RCR и RCL работают несколько по-другому. Инструкция  RCR  аналогично  инструкции сдвига вправо, при этом наиболее значащий бит сдвигается из флага переноса. На Рис. 5.11 показано, как  значение 10010110b (96h или 159 в десятичном представлении), записанное в регистре AL, циклически сдвигается вправо через флаг переноса, начальное значение которого равно 1, с помощью инструкции RCR AL,1. В результате получается  значение  11001011b  (0CBh или 203 в десятичном представлении), которое записывается обратно в регистр AL. Флаг переноса устанавливается в значение 0.

                              AL
   ----------------------------------------------------------
     | -----  -----  -----  -----  -----  -----  -----  ----- |
-->| | 1 |->| 0 |->| 0 |->| 1 |->| 0 |->| 1 |->| 1 |->| 0 | |---
|    | -----  -----  -----  -----  -----  -----  -----  -----  |          |
|  ----------------------------------------------------------         |
| Бит  7      6      5      4      3      2      1      0              |
|                                                                 -----          |
------------------------------------------------------|  1   |<------
                                                                  -----
                                               Флаг переноса

     Рис. 5.11  Пример  выполнения  инструкции  RCR  (циклический сдвиг вправо и перенос).

Инструкция RCL аналогично,  соответственно,  левому  сдвигу. При выполнении этой инструкции наименее значащий  бит  сдвигается из флага переноса.  Инструкции RCR и RCL полезно использовать для
сдвига операнда, состоящего из нескольких слов. Например, следующие  инструкции выполняют умножение значения в DX:AX,  размером в двойное слово, на 4:


```
             .
             .
             .
             shl   ax,1  ; бит 15 регистра AX сдвигается во
                         ; флаг переноса
             rcl   dx,1  ; флаг переноса сдвигается в бит 0
                         ; регистра DX
             shl   ax,1  ; бит 15 регистра AX сдвигается во
                         ; флаг переноса
             rcl   dx,1  ; флаг переноса сдвигается в бит 0
                         ; регистра DX
             .
             .
             .

```

Инструкции  циклического  сдвига,   аналогично  инструкциям сдвига, могут сдвигать операнд на 1 бит или на число бит,  заданных регистром CL.


