Операция:

Повторить строковую операцию до тех пор, пока не будет выполнено условие:

 - rep – Повторить пока равны.
 - repnz - Повторить пока не ноль.
 - repz -Повторить пока ноль.

Каждый префикс заставляет связанную строковую инструкцию (movs, lods, stos, cmps и т.д.) повторяться до тех пор, пока счетный регистр (CX) или нулевой флаг (ZF) не совпадут с проверяемым условием. Все эти три префикса являются синонимами и имеют один и тот же код операции. Префиксы повторяют выполнение следующей за ними команды, работающей со строками. Количество повторений
заносится в регистр CX до выполнения команды с префиксом. После каждого повторения команды регистр CX уменьшается на 1 и, если он стал равен нулю или в результате выполнения команды флаг ZF стал равен 0, происходит выход из цикла. Если команда используется в 32-разрядном режиме адресации, то в качестве счетчика используется регистр ECX. Например:  

Повторить, пока равно: скопируйте 8-битный байт из DS: [(E) SI] в регистр ES: [(E) DI] :

>rep movsb

Команды REP, REPE, REPNE, REPNZ, REPZ - на самом деле это префиксы к командам, работающим со строками, такими как MOVSB, SCSB и т.п. Эти префиксы позволяют организовывать циклы без использования команды LOOP. Перфиксы REP, REPE, REPZ синонимы друг-друга, и выполняют один и тот же код операции.
Пример 2:

```
mov si,offset str1
mov di,offset str2
mov cx,40
rep movsb  ;Перенос 40 байт из str1 в str2
  ```
  
Короче, repповторяет следующую строковую операцию ecx раз, movs копирует данные из ds:esi к es:edi и увеличивает или уменьшает указатели на основе установки флага направления. Таким образом, его повторение переместит диапазон памяти в другое место. Давайте проведём итог:
Команды – MOVS, LODS, SROS, CMPS, SCAS
Каждая из перечисленных команд может иметь префикс REP, который позволяет этим командам обрабатывать строки любой длины. Префикс кодируется непосредственно перед цепочечной командой, например:

>REP MOVSB.

Для использования префикса REP необходимо установить количество повторений в регистре CX. При выполнении цепочечной  команды с префиксом REP происходит уменьшение на 1 значения в регистре CX до нуля. Таким образом, можно обрабатывать строки любой длины. Флаг направления определяет направление повторяющейся операции:

 - Чтобы выполнить операцию слева направо необходимо с помощью команды CLD установить флаг DF в 0;
 - Чтобы выполнить операцию справа налево необходимо с помощью команды STD установить флаг DF в 1.

В следующем примере выполняется пересылка 10 байт из области START в END_S. Предположим, что оба регистра DS и ES инициализированы адресом сегмента данных:
 
 
```
 .
 .
 .
START DB 10 DUP('*')
END_S DB 10 DUP(' ')
 .
 .
 .
CLD          ;Сброс флага DF.
MOV CX,10    ;Счетчик на 10 байт.
LEA DI,END_S ;Адрес области "куда".
LEA SI,START ;Адрес области "откуда".
REP MOVSB    ;Переслать данные.
 .
 .
 .

```

Для области, принимающей строку, сегментным регистром, является регистр ES, а регистр DI содержит относительный адрес области, принимающий строку. Для области, передающей строку, сегментным регистром является регистр DS, а регистр SI содержит относительный адрес. Таким образом, в начале программы перед выполнением команды MOVS необходимо инициализировать регистр ES
вместе с регистром DS, а также загрузить требуемые относительные адреса полей в регистры DI и SI. В зависимости от состояния флага DF команда MOVS производит увеличение или уменьшение на 1 (для байта) или на 2 (для слова) содержимого регистров DI и SI. Префикс REP также имеет следующие вариации:

 - REP — это безусловное повторение, которое повторяет операцию, пока CX не станет равным нулю.

 - REPE или REPZ — это условное повторение, которое повторяет операцию до тех пор, пока нулевой флаг (ZF) указывает на равенство нулю результата (сам ZF установлен в единицу). Повторение останавливается, когда ZF указывает на неравенство результата нулю (ZF сброшен в ноль), или когда CX равен нулю.

 - REPNE или REPNZ — это также условное повторение, которое повторяет операцию до тех пор, пока нулевой флаг указывает на неравенство нулю результата. Повторение останавливается, когда ZF указывает на равенство нулю результата, или когда CX уменьшается до нуля.

# REP

Повторить следующую строковую операцию

### Влияние команды на флаги и форматы команды:

[OF](http://www.club155.ru/x86internalreg-eflags#OF "Регистр флагов - OF (Флаг переполнения, бит 11)") [DF](http://www.club155.ru/x86internalreg-eflags##DF "Регистр флагов - DF (Флаг направления, бит 10)") [IF](http://www.club155.ru/x86internalreg-eflags#IF "Регистр флагов - IF (Флаг разрешения прерываний, бит 9)") [TF](http://www.club155.ru/x86internalreg-eflags#TF "Регистр флагов - TF (Флаг трассировки, бит 8)")  [SF](http://www.club155.ru/x86internalreg-eflags#SF "Регистр флагов - SF (Флаг знака, бит 7)") [ZF](http://www.club155.ru/x86internalreg-eflags#ZF "Регистр флагов - ZF (Флаг нуля, бит 6)")[AF](http://www.club155.ru/x86internalreg-eflags#AF "Регистр флагов - AF (Флаг вспомогательного переноса, бит 4)")  [PF](http://www.club155.ru/x86internalreg-eflags#PF "Регистр флагов - PF (Флаг четности, бит 2)") [CF](http://www.club155.ru/x86internalreg-eflags#CF "Регистр флагов - CF (Флаг переноса, бит 0)")

| Код   | Команда              | Описание                                                                                   | Проц.    | Пример      |
| ----- | -------------------- | ------------------------------------------------------------------------------------------ | -------- | ----------- |
| F3 6C | REP INS *r/m8*,DX    | Загрузить (E)CX байт из порта в/в DX в память по адресу ES:(E)DI                           | Intel286 | rep insb    |
| F3 6D | REP INS *r/m16*,DX   | Загрузить (E)CX&amp;nbsp; слов из порта в/в DX в память по адресу ES:(E)DI                 | Intel286 | rep insw    |
| F3 6D | REP INS _r/m32_,DX   | Загрузить (E)CX  двойных слов из порта в/в DX в память по адресу ES:(E)DI                  | Intel386 | rep insd    |
| F3 A4 | REP MOVS _m8,m8_     | Записать по адресу ES:(E)DI блок из (E)CX байт, считываемый по адресу DS:(E)SI             | 8086     | rep movsb   |
| F3 A5 | REP MOVS _m16,m16_   | Записать по адресу ES:(E)DI блок из (E)CX  слов, считываемый по адресу DS:(E)SI            | 8086     | rep movsw   |
| F3 A5 | REP MOVS _m32,m32_   | Записать по адресу ES:(E)DI блок из (E)CX  двойных слов, считываемый по адресу DS:(E)SI    | Intel386 | rep movsd   |
| F3 6E | REP OUTS DX,_r/m8_   | Вывести блок из (E)CX байт из памяти по адресу DS:(E)SI в порт в/в по адресу в DX          | Intel286 | rep outsb   |
| F3 6F | REP OUTS DX,_r/m16_  | Вывести блок из (E)CX слов из памяти по адресу DS:(E)SI в порт в/в по адресу в DX          | Intel286 | rep outsw   |
| F3 6F | REP OUTS DX,_r/m32_  | Вывести блок из (E)CX  двойных слов из памяти по адресу DS:(E)SI в порт в/в по адресу в DX | Intel386 | rep outsd   |
| F3 AC | REP LODS AL          | Считать блок из (E)CX байт по адресу DS:(E)SI в AL                                         | 8086     | rep lodsb   |
| F3 AD | REP LODS AX          | Считать блок из (E)CX слов по адресу DS:(E)SI в AX                                         | 8086     | rep lodsw   |
| F3 AD | REP LODS EAX         | Считать блок из (E)CX двойных слов по адресу DS:(E)SI в EAX                                | Intel386 | rep lodsd   |
| F3 AA | REP STOS _m8_        | Заполнить блок из (E)CX байт по адресу ES:(E)DI содержимым AL                              | 8086     | rep stosb   |
| F3 AB | REP STOS _m16_       | Заполнить блок из (E)CX слов по адресу ES:(E)DI содержимым AX                              | 8086     | rep stosw   |
| F3 AB | REP STOS _m32_       | Заполнить блок из (E)CX двойных слов по адресу ES:(E)DI содержимым EAX                     | Intel386 | rep stosd   |
| F3 A6 | REPE CMPS _m8,m8_    | Найти неравные байты в блоках из (E)CX байт по адресам DS:(E)SI и ES:(E)DI                 | 8086     | repe cmpsb  |
| F3 A7 | REPE CMPS _m16,m16_  | Найти неравные слова в блоках из (E)CX слов по адресу DS:(E)SI и ES:(E)DI                  | 8086     | repe cmpsw  |
| F3 A7 | REPE CMPS _m32,m32_  | Найти неравные двойные слова в блоках из (E)CX двойных слов по адресу DS:(E)SI и ES:(E)DI  | Intel386 | repe cmpsd  |
| F3 AE | REPE SCAS _m8_       | Найти байт не равный AL в блоке из (E)CX байт по адресу ES:(E)DI                           | 8086     | repe scasb  |
| F3 AF | REPE SCAS _m16_      | Найти слово не равное AX в блоке из (E)CX слов по адресу ES:(E)DI                          | 8086     | repe scasw  |
| F3 AF | REPE SCAS _m32_      | Найти двойное слово не равное EAX в блоке из (E)CX двойных слов по адресу ES:(E)DI         | Intel386 | repe scasd  |
| F2 A6 | REPNE CMPS _m8,m8_   | Найти равные байты в блоках из (E)CX байт по адресам DS:(E)SI и ES:(E)DI                   | 8086     | repne cmpsb |
| F2 A7 | REPNE CMPS _m16,m16_ | Найти равные слова в блоках из (E)CX слов по адресу DS:(E)SI и ES:(E)DI                    | 8086     | repne cmpsw |
| F2 A7 | REPNE CMPS _m32,m32_ | Найти равные двойные слова в блоках из (E)CX двойных слов по адресу DS:(E)SI и ES:(E)DI    | Intel386 | repne cmpsd |
| F2 AE | REPNE SCAS _m8_      | Найти байт равный AL в блоке из (E)CX байт по адресу ES:(E)DI                              | 8086     | repne scasb |
| F2 AF | REPNE SCAS _m16_     | Найти слово равное AX в блоке из (E)CX слов по адресу ES:(E)DI                             | 8086     | repne scasw |
| F2 AF | REPNE SCAS _m32_     | Найти двойное слово равное EAX в блоке из (E)CX двойных слов по адресу ES:(E)DI            | Intel386 |   repne scasd          |



### Описание:

Префиксы REP (F3h), REPE (F3h) и REPNE (F2h) применяются со строковыми операциями. Каждый префикс заставляет строковую команду, которая следует за ним, повторяться указанное в регистре счетчике (E)CX количество раз или, кроме этого, (для префиксов REPE и REPNE) пока не встретится указанное условие во флаге ZF.

Мнемоники REPZ и REPNZ являются синонимами префиксов REPE и REPNE соответственно и имеют одинаковые с ними коды. Префиксы REP и REPE/REPZ также имеют одинаковый код F3h, конкретный тип префикса задается неявно той командой, перед которой он применен. Если префикс повторения применяется с командой или в комбинации, которая не представлена в таблице 6.100, то результат выполнения такой команды неопределен (обычно этот префикс просто игнорируется).

Все описываемые префиксы могут применяются только к одной строковой команде за один раз. Чтобы повторить блок команд, используется команда LOOP или другие циклические конструкции.

Полный список действий, предпринимаемых процессором, при исполнении команды с префиксом повторения выглядит следующим образом:

-   если атрибут размера адреса команды равен 16 бит, то в качестве регистра счетчика используется регистр CX, если атрибут размера адреса равен 32 бита — регистр ECX;
-   проверка регистра счетчика, если он равен 0, то выйти из цикла и перейти к следующей команде;
-   обработка любых поступивших запросов на прерывание;
-   однократное исполнение заданной строковой операции;
-   уменьшение регистра счетчика на 1 (флаги не изменяются);
-   если обрабатываемая строковая операция — команда SCAS или CMPS, то осуществляется проверка флага ZF, если условие повторения, задаваемое префиксом (флаг ZF равен 1 для префикса REPE/REPZ или флаг ZF равен 0 для префикса REPNE/REPNZ), не сохранилось, то выйти из цикла и перейти к следующей команде;
-   вернуться к началу цикла для следующего повторения.

Команды CMPS и SCAS с префиксами условного повторения могут завершаться по двум причинам: если счетчик повторений (E)CX исчерпан и если флаг ZF не отвечает условию повторения. Эти два случая могут различаться при помощи команды JCXZ или команд условных переходов, которые проверяют флаг ZF (команды JZ, JNZ и JNE).

### Операция:

```
IF AddresSize = 16

  THEN Использовать CX для CountReg;

  ELSE (* AddresSize = 32 *) Использовать ECX для CountReg;

FI;

WHILE CountReg ¹ 0

DO

  Обслуживание прерываний (если они поступили);

  Выполнение основной строковой команды;

  CountReg = CountReg - 1;

  IF (Основная команда CMPSB, CMPSW, CMPSD, SCASB, SCASW или SCASD)

  THEN

     IF (команда REP/REPE/REPZ) AND (ZF = 0)

     THEN exit WHILE loop;

     ELSE

        IF (Команда REPNZ или REPNE) AND (ZF = 1)

        THEN exit WHILE loop;

        FI;

     FI;

  FI;

OD;

```

### Особые ситуации защищенного режима:

Нет.

### Особые ситуации режима реальной адресации:

Нет.

### Особые ситуации режима V86:

Нет.

### Замечание:

Не все порты ввода/вывода могут поддерживать скорость, на которой выполняются команды REP INS и REP OUTS.

Когда происходит ошибка во время выполнения команд CMPS или SCAS с префиксом REPNE, значение EFLAGS восстанавливается в состояние предшествующее выполнению команды. Поскольку SCAS и CMPS не используют EFLAGS в качестве входного значения, то процессор может возобновить команду после обработки ошибки.

Использование префикса REP (F3h) с SIMD-командами ANDPS, ANDNPS, COMISS, FXRSTOR, FXSAVE, ORPS, LDMXCSR, MOVAPS, MOVHPS, MOVLPS, MOVMSKPS, MOVNTPS, MOVUPS, SHUFPS, STMXCSR, UCOMISS, UNPCKHPS, UNPCKLPS и XORPS. является зарезервированной недокументированной функцией. Различные модели процессоров по разному реагируют на эту ситуацию. Не рекомендуется применять в программах комбинацию этих команд и префикса REP, т.к. в дальнейших моделях процессоров эта функция может быть изменена или исключена.

В некоторых моделях процессоров AMD при совпадении большого количества условий (т.е. очень редко) возможна некорректная работа команды REP MOVS с префиксом изменения размера адреса и начальным значением ECX =6.