Ваша система когда-нибудь жаловалась на то, что у вас не осталось свободного места, в то время как его было явно более чем достаточно?

## Иноды и метаданные

Файловая система должна хранить файлы, которые могут находиться в каталогах, которые, в свою очередь, могут иметь подкаталоги. При этом что-то где-то должно записывать информацию о расположении всех файлов файловой системы, имена файлов, их размер, к каким учетным записям они принадлежат, какие у них разрешения и т.д. Данная информация называется **_метаданными_** — данные, которые описывают другие данные. Метаданные хранятся в иноде файла.

**Инод** (или _**«индексный дескриптор»**_, **_«inode»_**, от англ. _«**i**ndex **node**»_) — это структура данных, в которой хранятся метаданные о стандартных файлах, каталогах или других объектах файловой системы. Каждый используемый инод ссылается на 1 файл. Каждый файл имеет 1 инод. Каталоги, символьные и блочные устройства — всё это является файлами, а значит у каждого из них есть по 1 иноду.

   - Информация об инодах хранится в специальной таблице, расположенной, обычно, в начале каждого раздела диска. Каждый раздел имеет свою, отдельную таблицу инодов.

   - Для каждого файла в каталоге есть запись, содержащая имя файла и связанный с ним **номер инода**. Вся остальная информация о файле извлекается из таблицы инодов с помощью номера инода файла.

   - Иноды уникальны только в границах разделов своих файловых систем. Если у вас есть два файла, которые находятся на разных разделах диска, то у них могут быть одинаковые номера инодов.

Если у вас закончатся иноды, то вы больше не сможете создавать новые файлы, даже если у вас осталось место в разделе диска.

**losst:** Inode - это структура данных в которой хранится информация о файле или директории в файловой системе. В файловой системе Linux, например Ext4, у файла есть не только само его содержимое, например, тот текст, но и метаданные, такие как имя, дата создания, доступа, модификации и права. Вот эти метаданные и хранятся в Inode. У каждого файла есть своя уникальная Inode и именно здесь указано в каких блоках находятся данные файла.

Это довольно низкоуровневое понятие, но обычным пользователям приходится взаимодействовать с ним когда эти самые Inode заканчиваются. Возможно вы уже встречались с ошибкой когда место на диске ещё есть, но программа не может создать файл, потому что Inode закончились. В этой статье мы подробно разберемся что такое Inode, а также попытаемся выяснить как избежать связанных с ними проблем.

Другими словами метаданные это информация о другой информации, или данные, относящиеся к дополнительной информации о содержимом или объекте. Метаданные раскрывают сведения о признаках и свойствах, характеризующих какие-либо [сущности](https://ru.wikipedia.org/wiki/%D0%A1%D1%83%D1%89%D0%BD%D0%BE%D1%81%D1%82%D1%8C_(%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D0%B8%D0%BA%D0%B0) "Сущность (информатика)"), позволяющие автоматически искать и управлять ими в больших информационных потоках. **Проще говоря**, метаданные — это данные о данных (об их составе, содержании, статусе, происхождении, местонахождении, качестве, форматах, объёме, условиях доступа, авторских правах и т. п.).

Ежедневно мы отправляем электронные сообщения или файлы. У каждого такого послания есть не только содержание, но и дата и время отправки, указание отправителя и получателя, тип вложения, его объём и прочие характеристики. Это и есть метаданные.

## Как получить информацию об инодах в Linux?

Вы можете легко вывести список номеров инодов с помощью следующей команды:

`ls –li /`

На следующем скриншоте показан мой корневой каталог с соответствующими номерами инодов:

![[Pasted image 20221026050511.png]]

Количество инодов в каждой файловой системе задается на этапе её создания, и, как правило, для большинства пользователей их количества более чем достаточно.

По умолчанию параметры файловой системы таковы, что создается 1 инод на 2 КБ пространства диска. Такого количества инодов достаточно для большинства систем. Скорее место на вашем жестком диске исчерпается раньше, чем закончатся все иноды. При необходимости, во время определения первоначальных параметров файловой системы, вы можете указать, сколько инодов требуется создать.

Если у вас всё-таки закончатся иноды, то ни вы, ни ваша система больше не сможете создавать новые файлы. Это довольно редкая ситуация, но все же она может возникнуть. Например, в старые времена некоторые почтовые серверы, которые хранили сообщения электронной почты в виде отдельных файлов (что быстро приводило к созданию больших коллекций маленьких файлов размером менее 2 килобайт), довольно часто сталкивались с данной проблемой. Однако, когда они перешли на использование баз данных, проблема решилась.

В некоторых файловых системах, таких как **[Btrfs](https://ravesli.com/linux-file-systems/#toc-12)**, **[JFS](https://ravesli.com/linux-file-systems/#toc-13)**, [**XFS**](https://ravesli.com/linux-file-systems/#toc-10), реализованы динамические иноды. При необходимости такие файловые системы могут увеличить количество доступных инодов.  

## Как работает инод?

При создании нового файла ему назначается номер инода и имя файла. **Номер инода** — это уникальный номер файла в файловой системе. И имя, и номер инода хранятся в виде записи в каталоге.

Когда я запустил команду `ls –li /`, то тем самым отобразил имена файлов корневого каталога и номера их инодов. Оставшаяся информация о владельце файла, принадлежности к группе, разрешениях на доступ, размере и т.д. была получена из таблицы инодов при помощи номера инода.

Вы можете перечислить информацию об инодах для каждой файловой системы с помощью следующей команды:

`df -hi`

![[Pasted image 20221026050531.png]]

## Иноды и ссылки

  

[**Символьные ссылки**](https://ravesli.com/hard-links-and-symlinks-in-linux/#toc-1) являются хорошо известной особенностью Linux. Но что происходит с инодами, когда мы создаем символьную ссылку? На следующем скриншоте у меня есть файл с именем _file1_, каталог под названием _dir1_, внутри которого расположилась символьная ссылка под названием _slink1_, которая указывает на `../file1`:

![[Pasted image 20221026050724.png]]

Теперь сравним их номера инодов:

`ls -liR`

![[Pasted image 20221026050734.png]]

Как и ожидалось, _dir1_ и _file1_ имеют разные номера инодов. Но то же самое относится и к символьной ссылке. **Когда вы определяете символьную ссылку, то тем самым создаете новый файл**. В своих метаданных он указывает на целевой объект. Для каждой создаваемой вами символьной ссылки вы используете новый инод.

Теперь давайте создадим [**жесткую ссылку**](https://ravesli.com/hard-links-and-symlinks-in-linux/#toc-0) и посмотрим, что произойдет с инодами:

`ln ../file1 hlink1`

Выводим список номеров инодов:

![[Pasted image 20221026050754.png]]

Вы можете видеть, что _file1_ и _hlink1_ имеют одинаковый номер инода. **Жесткая ссылка не создает новый файл, она лишь предоставляет новое имя для тех же данных**. Такое возможно благодаря введению механизма инодов.

_**Примечание**_: В более старых версиях Linux можно было создать жесткую ссылку на каталог. Было даже возможно сделать так, чтобы каталог стал родительским самому себе. Но теперь установлены некоторые ограничения, чтобы пользователи не создавали очень запутанную структуру каталогов.

## Польза от инодов

Принцип работы инодов также объясняет, почему невозможно создать жесткую ссылку из одной файловой системы в другую. Разрешение такой задачи открыло бы возможность наличия конфликтующих номеров инодов. В то же время, символьная ссылка может быть создана в разных файловых системах.

Поскольку жесткая ссылка имеет тот же номер инода, что и исходный файл, то вы можете удалить исходный файл, и данные по-прежнему будут доступны по жесткой ссылке. Всё, что вы сделали в этом случае, — это удалили одно из имен, указывающих на заданный номер инода. Данные, связанные с этим инодом, будут оставаться доступными до тех пор, пока все имена, связанные с ним, не будут удалены.

Иноды также являются важной причиной, по которой Linux-системы могут обновляться без необходимости перезагрузки: один процесс может использовать библиотечный файл, в то время как другой процесс заменяет этот файл новой версией. Уже запущенный процесс будет продолжать использовать старый файл, в то время как каждый новый вызов к нему приведет к использованию новой версии.

Еще одна интересная функция, которая поставляется с инодами, — это возможность хранить данные в самом иноде. Это называется **встраиванием** (англ. _«inlining»_). Этот метод хранения имеет преимущество в экономии места, поскольку не требует использования блоков данных, но при этом также увеличивает время поиска, избегая дополнительного доступа к диску для получения данных.

В некоторых файловых системах, таких как [**ext4**](https://ravesli.com/linux-file-systems/#toc-6), есть опция под названием _inline_data_, которая позволяет операционной системе хранить данные вышеописанным способом. Из-за ограничения размера _встраивание_ работает только для очень маленьких файлов.  

## Заключение

  

Иноды — это не то, с чем вы взаимодействуете напрямую, но они играют важную роль в работе операционной системы. Если раздел должен содержать очень много маленьких файлов, то знание и понимание того, что такое иноды и как они работают, может избавить вас от многих проблем в будущем.