# Сетевые пакеты

В компьютерных сетях пакет — это определённым образом оформленный блок данных, передаваемый по сети в пакетном режиме. Компьютерные линии связи, которые не поддерживают пакетного режима, как, например, традиционная телекоммуникационная связь точка-точка, передают данные просто в виде последовательности байтов, символов или битов поодиночке. Если данные сформированы в пакеты, битрейт коммуникационной среды можно более эффективно распределить между пользователями, чем в сети с коммутацией каналов. При использовании сетей с коммутацией пакетов можно надёжно гарантировать пороговый битрейт, ниже которого он
опускаться не будет. 

Сетевой пакет может состоять из служебной информации, включающей стартовые биты (преамбулу), заголовки (headers) и прицеп (trailer), и полезную нагрузку (payload). Между пакетами, посылаемыми в сеть, обычно соблюдается межкадровый интервал (англ. Interframe gap). Максимальная длина нагрузки называется maximum transmission unit (MTU).
# Разница между сетевым пакетом и IP-пакетом

**Сетевой пакет** и **IP-пакет** — это термины, которые часто используются в контексте сетевых коммуникаций, но они относятся к разным аспектам передачи данных в сети.

#### Сетевой пакет

**Сетевой пакет** — это обобщённый термин, который описывает единицу данных, передаваемую по сети. Пакеты используются на различных уровнях модели OSI и могут включать данные и информацию, необходимую для их передачи через сеть.

- **Уровни модели OSI**: Сетевые пакеты могут существовать на различных уровнях модели OSI, включая канальный, сетевой, транспортный и прикладной уровни.
- **Состав**: Пакеты обычно включают заголовок (header), полезную нагрузку (payload) и иногда завершение (trailer). Заголовок содержит контрольную информацию, такую как адреса отправителя и получателя, контрольные суммы и другие данные, необходимые для маршрутизации и доставки пакета.
- **Примеры**: Ethernet-фреймы (канальный уровень), TCP/UDP-сегменты (транспортный уровень).

#### IP-пакет

**IP-пакет** — это конкретный тип сетевого пакета, который используется на сетевом уровне модели OSI для передачи данных через сети, использующие протокол IP (Internet Protocol).

- **Протокол**: IP-пакет используется в протоколах IPv4 и IPv6.
- **Состав**: IP-пакет состоит из заголовка IP (IP header) и полезной нагрузки (payload). Заголовок IP включает важную информацию, такую как IP-адреса отправителя и получателя, длину пакета, идентификатор пакета, флаги и время жизни (TTL).
- **Маршрутизация**: IP-пакеты могут проходить через множество маршрутизаторов, прежде чем достигнут своего конечного адресата. Каждый маршрутизатор использует информацию из заголовка IP для принятия решений о маршрутизации.

### Сравнение

|Характеристика|Сетевой пакет|IP-пакет|
|---|---|---|
|**Определение**|Общий термин для единицы данных в сети|Специфический тип пакета на сетевом уровне|
|**Протоколы**|Может использоваться на разных уровнях и протоколах|Используется в протоколах IPv4 и IPv6|
|**Состав**|Включает заголовок, полезную нагрузку и иногда трейлер|Включает заголовок IP и полезную нагрузку|
|**Уровень OSI**|Канальный, сетевой, транспортный, прикладной|Сетевой уровень|
|**Примеры**|Ethernet-фреймы, TCP/UDP-сегменты|IPv4-пакеты, IPv6-пакеты|
|**Маршрутизация**|Зависят от конкретного уровня и протокола|Маршрутизируются по IP-адресам|

### Примеры взаимодействия

1. **Передача данных в Ethernet сети**:
    
    - **Ethernet-фрейм**: На канальном уровне данные упаковываются в Ethernet-фрейм, который включает Ethernet-заголовок и полезную нагрузку.
    - **IP-пакет**: Полезная нагрузка Ethernet-фрейма может включать IP-пакет, который, в свою очередь, содержит IP-заголовок и данные (например, TCP-сегмент).
2. **Передача данных через интернет**:
    
    - **TCP-сегмент**: На транспортном уровне данные разбиваются на TCP-сегменты, которые включают TCP-заголовок и полезную нагрузку.
    - **IP-пакет**: TCP-сегменты инкапсулируются в IP-пакеты, которые затем маршрутизируются через интернет, используя IP-заголовки для навигации.

Таким образом, сетевые пакеты — это общее понятие, охватывающее различные единицы данных на всех уровнях модели OSI, в то время как IP-пакеты — это конкретные единицы данных на сетевом уровне, используемые для маршрутизации и передачи данных в сетях, использующих протокол IP. 

Простыми словами - сетевой (уровен: L3) пакет (формат передачи).
# Разметка пакета

Пакет состоит из двух типов данных: управляющей информации и данных пользователя (называемых также полезной нагрузкой). Управляющая информация содержит данные, необходимые для доставки данных пользователя: адреса отправителя и получателя, коды обнаружения ошибок (типа контрольных сумм) и информацию об очерёдности. Как правило, управляющая информация содержится в заголовке и хвосте пакета, а между ними размещаются пользовательские данные.

# Структура сетевого пакета 

Сетевой пакет данных, передаваемый по сети, состоит из трех основных частей: заголовка (header), полезных данных (payload) и хвоста (trailer).

1. **Заголовок (Header)**
    
    Заголовок содержит управляющую информацию, необходимую для доставки пакета от отправителя к получателю. В нем указываются важные данные, такие как:
    
    - **Источник и назначение**: Адреса отправителя и получателя (например, IP-адреса).
    - **Тип данных**: Определяет тип передаваемых данных или протокол, который будет использоваться для обработки пакета (например, TCP, UDP).
    - **Информация о последовательности**: Используется для восстановления порядка пакетов, если они передаются с использованием протокола, который поддерживает последовательную передачу данных (например, TCP).
    - **Контрольные суммы**: Используются для проверки целостности данных.
    - **Флаги**: Указывают на различные условия и состояния (например, начало или конец передачи).
    
    **Пример**: В случае IP-пакета заголовок может включать версии протокола, длину заголовка, время жизни (TTL), тип сервиса (ToS) и другие параметры.
    
2. **Полезные данные (Payload)**
    
    Полезные данные, или «пользовательские данные», представляют собой основное содержимое пакета, которое передается между отправителем и получателем. Это может быть текст, изображения, видео или любой другой тип данных, который нужно передать через сеть.
    
    **Пример**: В случае HTTP-запроса полезные данные могут включать содержимое веб-страницы или файлы, передаваемые по сети.
    
3. **Хвост (Trailer)**
    
    Хвост содержит дополнительную управляющую информацию, которая обычно используется для проверки целостности данных на уровне канала передачи. Часто он включает в себя:

     **Обнаружение ошибок:**
    
     - **Контрольную сумму (CRC)**: Используется для проверки целостности пакета данных и выявления ошибок, которые могли возникнуть при передаче.
      - **Код обнаружения ошибок**: Для контроля и коррекции ошибок на уровне канала передачи.

     Более эффективным и надёжным методом обнаружения ошибок является расчёт контрольной суммы или циклического избыточного кода над содержимым пакета, чем проверка каждого символа с помощью бита чётности. Хвостовая часть пакета часто содержит данные проверки ошибок, возникших во время передачи пакета по сети.
    
    **Пример**: На уровне Ethernet кадра хвост может включать в себя поле с контрольной суммой, которая позволяет проверить целостность кадра.
    

# Пример структурирования пакета

Рассмотрим пример структурирования пакета данных в сети на примере TCP/IP:

- **Заголовок Ethernet**: Включает адреса MAC отправителя и получателя, тип протокола.
- **Заголовок IP**: Содержит IP-адреса отправителя и получателя, время жизни пакета (TTL), длину пакета и другие параметры.
- **Заголовок TCP**: Включает порты отправителя и получателя, номер последовательности, номер подтверждения, флаги управления и другие параметры.
- **Полезные данные**: Конкретное содержимое, передаваемое от одного узла к другому, например, часть веб-страницы или текстовое сообщение.
- **Хвост Ethernet**: Включает контрольную сумму для проверки целостности данных на уровне канала передачи.

Различные коммуникационные протоколы используют разные соглашения для разделения элементов и для форматирования данных. В протоколе «двоичной синхронной передачи» пакет отформатирован в 8-битных байтах, а для разделения элементов используются специальные символы. В других протоколах, таких как Ethernet, зафиксировано начало заголовка и элементов данных, их расположение относительно начала пакета. Некоторые протоколы форматируют информацию на уровне битов, а не байтов.

Хорошей аналогией является рассмотрение пакета как письма: заголовок является конвертом, а область данных — это то, что человек вкладывает внутрь конверта. Разница, однако, состоит в том, что некоторые сети могут в случае необходимости разбивать большие пакеты на более мелкие (заметим, что эти меньшие элементы данных также форматируются как пакеты).

При проектировании сети с применением пакетов можно достичь двух важных результатов: обнаружение ошибок и многохостовая адресация.

**Адрес хоста**

Современные сети обычно соединяют между собой три или более хоста. В таких случаях заголовок пакета обычно содержит информацию, в которой записан фактический адрес хоста.

В сложных сетях, построенных из нескольких узлов коммутации и маршрутизации, такие как ARPANET или современный интернет, ряд пакетов, отправленных с одного компьютера на другой, может следовать разными маршрутами. Эта технология называется пакетной коммутацией.

# Фрагментация пакета

Существует возможность фрагментации пакета — генерация двух сетевых пакетов из одного. Происходит при превышении длины кадра MTU интерфейса, через который он в данный момент проходит. Фрагментация (и е запрещение) поддерживается протоколом IP и не предусмотрена в большинстве других протоколов. Если сетевой адаптер обнаруживает кадр длиннее его media MTU, то этот кадр обычно отбрасывается. Такое случается, если на одном хосте разрешены jumbo-кадры, а на другом — нет. 

Фрагментация IP-пакета увеличивает нагрузку на центральный процессор и снижает скорость передачи полезных данных этого пакета (на 2÷50% в Ethernet-сети в зависимости от длины кадра), поэтому её стараются избегать. При потере любого фрагмента повторно должна быть передана вся последовательность, что является дополнительным риском снижения скорости. Сборка всех частей в исходный пакет производится только адресатом, даже если на каком-то участке сети MTU больше требуемого. Фрагментация пакетов может быть использована в сетевых атаках и зондировании сетей.

Теперь о самом смещение, которое проще всего показать на примере. Давайте представим ситуацию, что между узлами А и Б мы хотим передавать IP-пакеты размером 7600 байт, но максимально допустимый размер пакета, который мы можем передать в канале связи равен 1500 байт, следовательно, при передаче исходного пакета будет выполняться фрагментация, а заодно будет задано и смещение для поля данных. 

Обратите внимание на Рисунок.

![[Pasted image 20240626032424.png]]

Здесь как раз показана ситуация, описанная словами выше. Давайте поясним. Ноутбук генерирует IP-пакет в сторону ПК размером 7600 байт, из этих 7600 байт под данные выделено 7580 байт, а под заголовок 20 байт. Еще раз хочу напомнить, что смещение применяется к полю данных и это значение нужно, чтобы принимающая сторона смогла правильно собрать исходное поле данных из полученных кусочков. Получается, что у первого пакета смещение равно нулю и когда ПК его получит, он отрежет заголовок и поле данных первого пакета он поставит на первое место.

Но давайте сейчас немного уйдем в сторону. Компьютер поймет, что он получатель по IP-адресу назначения в первом пакете, если этот адрес будет совпадать с тем, что задан в его настройках. Получив первый пакет, компьютер посмотрит, на флаги и поймет, что этот пакет является не самостоятельной единицей, а частью чего-то большего, поэтому он выделит ресурсы своего буфера и будет ждать следующие кусочки. По сути у нас получается очередь из пакетов, которая обрабатывается получателем по методу FIFO (first in, first out) или первым пришел – первым ушел. И так можно понять, что поля идентификатор пакета, флаги и смещение фрагмента используется для использования фрагментации.

