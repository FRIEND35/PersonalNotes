
**Платформа:** https://academy.hackthebox.com
# Networking Overview

---

Сеть позволяет двум компьютерам взаимодействовать друг с другом. Существует широкий спектр `topologies` (сетка/дерево/звезда), `mediums` (Ethernet/оптоволокно/коаксиальный/беспроводной) и `protocols` (TCP/UDP/IPX), который можно использовать для облегчения работы сети. Специалистам по безопасности важно понимать работу сети, потому что при сбое сети ошибка может быть молчаливой, в результате чего мы что-то упускаем.

Настроить большую плоскую сеть не так уж и сложно, и она может быть надежной, по крайней мере, в эксплуатационном отношении. Однако плоская сеть — это все равно, что построить дом на земельном участке и считать его безопасным, потому что на двери есть замок. Создав множество небольших сетей и заставив их обмениваться данными, мы можем добавить уровни защиты. Перевернуть сеть несложно, но сделать это быстро и бесшумно сложно и замедлит атаку злоумышленников. Возвращаясь к домашнему сценарию, давайте рассмотрим следующие примеры:

#### Example No. 1

Создание небольших сетей и размещение вокруг них списков контроля доступа — это все равно, что возведение забора вокруг границы собственности, который создает определенные точки входа и выхода. Да, злоумышленник может перепрыгнуть через забор, но это выглядит подозрительно и встречается нечасто, что позволяет быстро обнаружить вредоносную активность. Почему сеть принтеров взаимодействует с серверами через HTTP?

#### Example No. 2

Уделять время планированию и документированию назначения каждой сети — это все равно, что размещать освещение вокруг объекта, обеспечивая видимость всей активности. Почему сеть принтера вообще взаимодействует с Интернетом?

#### Example No. 3

Кусты вокруг окон отпугивают людей, пытающихся открыть окно. Точно так же, как системы обнаружения вторжений, такие как Suricata или Snort, являются сдерживающим фактором для сканирования сети. Почему сканирование портов происходит из сети принтера?

Эти примеры могут показаться глупыми, и вполне разумно запретить принтеру выполнять все вышеперечисленное. Однако, если принтер находится в «плоской/24-сети» и получает адрес DHCP, наложить на него такие ограничения может быть сложно.

---

## Story Time - A Pentesters Oversight

Большинство сетей используют `/24` подсеть, настолько, что многие тестеры на проникновение устанавливают эту маску подсети (255.255.255.0) без проверки. Сеть /24 позволяет компьютерам общаться друг с другом, если первые три октета IP-адреса совпадают (например: 192.168.1.xxx). Установка маски подсети на `/25` делит этот диапазон пополам, и компьютер сможет общаться только с компьютерами на «своей половине». Мы видели отчеты о тестах на проникновение, в которых оценщик утверждал, что контроллер домена был отключен от сети, хотя на самом деле он находился в другой сети. Структура сети была примерно такой:

- Server Gateway: 10.20.0.1/25
- Domain Controller: 10.20.0.10/25
- Client Gateway: 10.20.0.129/25
- Client Workstation: 10.20.0.200/25
- Pentester IP: 10.20.0.252/24 (Set Gateway to 10.20.0.1)

Пентестер связался с клиентскими рабочими станциями и решил, что они проделали отличную работу, поскольку им удалось украсть пароль рабочей станции через Impacket. Однако из-за неспособности понять сеть им так и не удалось выйти из клиентской сети и достичь более «ценных» целей, таких как серверы баз данных. Надеюсь, если это покажется вам запутанным, вы сможете вернуться к этому утверждению в конце модуля и понять его!

---

## Basic Information

Давайте посмотрим на следующую общую диаграмму того, как может работать установка «Работа на дому».

![[Pasted image 20240811102344.png]]

Весь Интернет основан на множестве разделенных сетей, как показано в примере и отмечено как "`Home Network`" и " `Company Network`". Мы можем представить `networking` как доставка почты или посылок, отправленных одним компьютером и полученных другим.

Предположим, мы представляем себе сценарий, что мы хотим посетить веб-сайт компании с нашего "`Home Network`". В этом случае мы обмениваемся данными с веб-сайтом компании, расположенным в их « `Company Network`." Как и при отправке почты или пакетов, мы знаем адрес, по которому должны идти пакеты. Адрес сайта или `Uniform Resource Locator` ( `URL`), который мы вводим в наш браузер, также известен как `Fully Qualified Domain Name` ( `FQDN`).

Разница между `URLs` и `FQDN`это то, что:

- а `FQDN` ( `www.hackthebox.eu`) указывает только адрес «здания» и
- а `URL` ( `https://www.hackthebox.eu/example?floor=2&office=dev&employee=17`) также указывает " `floor`, " " `office`, " " `mailbox`"и соответствующий" `employee`", для кого предназначен пакет.

Мы обсудим точные представления и определения более четко и точно в других разделах.

Дело в том, что мы знаем адрес, но не точное географическое положение адреса. В этой ситуации почтовое отделение может определить точное местоположение, а затем перенаправить пакеты в нужное место. Поэтому наше почтовое отделение пересылает наши посылки в главное почтовое отделение, представляя нашу `Internet Service Provider` ( `ISP`).

Наше почтовое отделение - это наша `router` который мы используем для подключения к "`Internet`"в сети.

Как только мы отправим нашу посылку через наше почтовое отделение ( `router`), пакет пересылается `main post office` ( `ISP`). Это главное почтовое отделение выглядит `address register`/ `phonebook` ( `Domain Name Service`), где находится этот адрес, и возвращает соответствующие географические координаты ( `IP address`). Теперь, когда мы знаем точное местоположение адреса, наша посылка отправляется прямо туда прямым рейсом через наше главное почтовое отделение.

После того, как веб-сервер получил наш пакет с запросом о том, как выглядит их сайт, веб-сервер отправляет нам обратно пакет с данными для представления сайта через почтовое отделение ( `router`) принадлежащий "`Company Network`" на указанный обратный адрес ( `our IP address`).

---

## Extra Points

Я надеюсь, что на этой диаграмме показанная сеть компании состоит из пяти отдельных сетей!

1. Веб-сервер должен находиться в демилитаризованной зоне (DMZ), поскольку клиенты в Интернете могут инициировать связь с веб-сайтом, что повышает вероятность его взлома. Размещение его в отдельной сети позволяет администраторам установить сетевую защиту между веб-сервером и другими устройствами.
    
2. Рабочие станции должны находиться в собственной сети, и в идеальном мире каждая рабочая станция должна иметь правило межсетевого экрана на основе хоста, запрещающее ей взаимодействие с другими рабочими станциями. Если рабочая станция находится в той же сети, что и сервер, сетевые атаки, такие как `spoofing` или `man in the middle` стать гораздо большей проблемой.
    
3. Коммутатор и маршрутизатор должны находиться в «сети администрирования». Это не позволяет рабочим станциям отслеживать любую связь между этими устройствами. Я часто проводил тест на проникновение и видел `OSPF` Рекламные объявления (сначала открывайте кратчайший путь). Поскольку у роутера не было `trusted network`любой человек во внутренней сети мог отправить вредоносную рекламу и выполнить `man in the middle` атака на любую сеть.
    
4. IP-телефоны должны находиться в собственной сети. С точки зрения безопасности это делается для того, чтобы компьютеры не могли подслушивать общение. Помимо безопасности, телефоны уникальны в том смысле, что задержка/задержка значительны. Размещение их в собственной сети может позволить сетевым администраторам расставлять приоритеты для трафика, чтобы легче предотвратить высокую задержку.
    
5. Принтеры должны находиться в собственной сети. Это может показаться странным, но защитить принтер практически невозможно. Из-за особенностей работы Windows, если принтер сообщает, что во время задания печати требуется проверка подлинности компьютера, этот компьютер попытается выполнить `NTLMv2` аутентификация, что может привести к краже паролей. Кроме того, эти устройства отличаются постоянством и, как правило, на них отправляются тонны конфиденциальной информации.
    

---

## Fun Story

Во время COVID мне было поручено выполнить `Physical Penetration Test` через границы штатов, и мой штат находился под `stay at home` заказ. В компании, которую я тестировал, в офисе было минимальное количество сотрудников. Я решил купить дорогой принтер и использовал его, чтобы поставить в него реверс-шелл, чтобы при подключении к сети он отправлял мне шелл (удаленный доступ). Затем я отправил принтер в компанию и отправил фишинговое электронное письмо, в котором поблагодарил сотрудников за то, что они пришли, и объяснил, что принтер должен позволять им печатать или сканировать документы быстрее, если они хотят привезти что-то домой в WFH на несколько дней. Принтер был подключен почти мгновенно, и компьютер администратора их домена любезно отправил принтеру свои учетные данные!

Если бы клиент разработал безопасную сеть, эта атака, вероятно, была бы невозможна по многим причинам:

- Принтер не должен был иметь возможность подключаться к Интернету
- Рабочая станция не должна была иметь возможность обмениваться данными с принтером через порт 445.
- Принтер не должен иметь возможности инициировать подключения к рабочим станциям. В некоторых случаях комбинации принтера и сканера должны иметь возможность связываться с почтовым сервером для отправки отсканированных документов по электронной почте.