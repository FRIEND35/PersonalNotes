
# MAC Addresses

---

Каждый хост в сети имеет свой собственный `48`-кусочек ( `6 octets`) `Media Access Control` ( `MAC`) адрес, представленный в шестнадцатеричном формате. `MAC` это `physical address` для наших сетевых интерфейсов. Существует несколько различных стандартов MAC-адреса:

- Ethernet (IEEE 802.3)
- Bluetooth (IEEE 802.15)
- WLAN (IEEE 802.11)

Это потому, что `MAC` адрес адресует физическое соединение (сетевая карта, адаптер Bluetooth или WLAN) хоста. Каждая сетевая карта имеет свой индивидуальный MAC-адрес, который настраивается один раз на аппаратной стороне производителя, но всегда может быть изменен, по крайней мере временно.

Давайте посмотрим на пример такого MAC-адреса:

MAC-адрес:

- `DE:AD:BE:EF:13:37`
- `DE-AD-BE-EF-13-37`
- `DEAD.BEEF.1337`

| **Representation** | **1st Octet** | **2nd Octet** | **3rd Octet** | **4th Octet** | **5th Octet** | **6th Octet** |
| ------------------ | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Binary             | 1101 1110     | 1010 1101     | 1011 1110     | 1110 1111     | 0001 0011     | 0011 0111     |
| Hex                | DE            | AD            | BE            | EF            | 13            | 37            |

---

Когда IP-пакет доставлен, он должен быть адресован на `layer 2` на физический адрес хоста назначения или на маршрутизатор/NAT, отвечающий за маршрутизацию. Каждый пакет имеет `sender address` и `destination address`.

MAC-адрес состоит из `6 bytes`. Первая половина( `3 bytes` / `24 bit`) – это так называемый `Organization Unique Identifier` ( `OUI`) определяется `Institute of Electrical and Electronics Engineers` ( `IEEE`) для соответствующих производителей.

| **Representation** | **1st Octet** | **2nd Octet** | **3rd Octet** | **4th Octet** | **5th Octet** | **6th Octet** |
| ------------------ | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Binary             | `1101 1110`   | `1010 1101`   | `1011 1110`   | 1110 1111     | 0001 0011     | 0011 0111     |
| Hex                | `DE`          | `AD`          | `BE`          | EF            | 13            | 37            |

---

Последняя половина MAC-адреса называется `Individual Address Part` или `Network Interface Controller` ( `NIC`), который назначают производители. Производитель устанавливает эту последовательность битов только один раз и, таким образом, гарантирует уникальность полного адреса.

| **Representation** | **1st Octet** | **2nd Octet** | **3rd Octet** | **4th Octet** | **5th Octet** | **6th Octet** |
| ------------------ | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Binary             | 1101 1110     | 1010 1101     | 1011 1110     | `1110 1111`   | `0001 0011`   | `0011 0111`   |
| Hex                | DE            | AD            | BE            | `EF`          | `13`          | `37`          |

Если хост с целевым IP-адресом находится в той же подсети, доставка осуществляется непосредственно на физический адрес целевого компьютера. Однако если этот хост принадлежит другой подсети, кадр Ethernet адресуется этому хосту. `MAC address` ответственного маршрутизатора ( `default gateway`). Если адрес назначения кадра Ethernet совпадает с его собственным `layer 2 address`, маршрутизатор перешлет кадр на более высокие уровни. `Address Resolution Protocol` ( `ARP`) используется в IPv4 для определения MAC-адресов, связанных с IP-адресами.

Как и в случае с адресами IPv4, для MAC-адреса также имеются определенные зарезервированные области. К ним относится, например, локальный диапазон MAC.

|**Локальный диапазон**|
|---|
|0 `2`:00:00:00:00:00|
|0 `6`:00:00:00:00:00|
|0 `A`:00:00:00:00:00|
|0 `E`:00:00:00:00:00|

Более того, последние два бита первого октета могут играть еще одну важную роль. Как мы уже знаем, последний бит может иметь два состояния: 0 и 1. Последний бит идентифицирует MAC-адрес как `Unicast` ( `0`) или `Multicast` ( `1`). С `unicast`, это означает, что отправленный пакет достигнет только одного конкретного хоста.

#### MAC Unicast

| **Representation** | **1st Octet** | **2nd Octet** | **3rd Octet** | **4th Octet** | **5th Octet** | **6th Octet** |
| ------------------ | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Binary             | 1101 111`0`   | 1010 1101     | 1011 1110     | 1110 1111     | 0001 0011     | 0011 0111     |
| Hex                | D`E`          | AD            | BE            | EF            | 13            | 37            |

---

С `multicast`, пакет отправляется только один раз всем хостам в локальной сети, которые затем решают, принимать пакет или нет, на основе их конфигурации. `multicast` адрес — это уникальный адрес, как и адрес `broadcast` адрес, который имеет фиксированные значения октетов. `Broadcast` в сети представляет собой широковещательный вызов, при котором пакеты данных передаются одновременно из одной точки всем членам сети. В основном он используется, если адрес получателя пакета еще не известен. Примером является `ARP` ( `for MAC addresses`) и DHCP ( `for IPv4 addresses`) протоколы.

Определенные значения каждого октета отмечены `green`.

#### MAC Multicast

| **Representation** | **1st Octet** | **2nd Octet** | **3rd Octet** | **4th Octet** | **5th Octet** | **6th Octet** |
| ------------------ | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Binary             | `0000 0001`   | `0000 0000`   | `0101 1110`   | 1110 1111     | 0001 0011     | 0011 0111     |
| Hex                | `01`          | `00`          | `5E`          | EF            | 13            | 37            |

#### MAC Broadcast

| **Representation** | **1st Octet** | **2nd Octet** | **3rd Octet** | **4th Octet** | **5th Octet** | **6th Octet** |
| ------------------ | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Binary             | `1111 1111`   | `1111 1111`   | `1111 1111`   | `1111 1111`   | `1111 1111`   | `1111 1111`   |
| Hex                | `FF`          | `FF`          | `FF`          | `FF`          | `FF`          | `FF`          |

---

Второй последний бит в первом октете определяет, является ли это `global OUI`, определенный IEEE, или `locally administrated` MAC-адрес.

#### Global OUI

| **Representation** | **1st Octet** | **2nd Octet** | **3rd Octet** | **4th Octet** | **5th Octet** | **6th Octet** |
| ------------------ | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Binary             | 1101 11`0`0   | 1010 1101     | 1011 1110     | 1110 1111     | 0001 0011     | 0011 0111     |
| Hex                | D`C`          | AD            | BE            | EF            | 13            | 37            |

#### Locally Administrated

| **Representation** | **1st Octet** | **2nd Octet** | **3rd Octet** | **4th Octet** | **5th Octet** | **6th Octet** |
| ------------------ | ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Binary             | 1101 11`1`0   | 1010 1101     | 1011 1110     | 1110 1111     | 0001 0011     | 0011 0111     |
| Hex                | D`E`          | AD            | BE            | EF            | 13            | 37            |

---

## Address Resolution Protocol

MAC-адреса могут быть изменены/манипулированы или подделаны, поэтому на них не следует полагаться как на единственное средство безопасности или идентификации. Сетевые администраторы должны реализовать дополнительные меры безопасности, такие как сегментация сети и протоколы строгой аутентификации, для защиты от потенциальных атак.

Существует несколько векторов атак, которые потенциально могут быть использованы с использованием MAC-адресов:

- `MAC spoofing`: подразумевает изменение MAC-адреса устройства в соответствии с MAC-адресом другого устройства, обычно для получения несанкционированного доступа к сети.
    
- `MAC flooding`: это включает в себя отправку множества пакетов с разными MAC-адресами сетевому коммутатору, в результате чего он достигает емкости таблицы MAC-адресов и фактически препятствует его правильной работе.
    
- `MAC address filtering`: Некоторые сети могут быть настроены только на разрешение доступа к устройствам с определенными MAC-адресами, которые мы потенциально можем использовать, пытаясь получить доступ к сети с использованием поддельного MAC-адреса.
    

---

## Address Resolution Protocol

[Протокол разрешения адресов](https://en.wikipedia.org/wiki/Address_Resolution_Protocol) ( `ARP`) — сетевой протокол. Это важная часть сетевой связи, используемая для преобразования IP-адреса сетевого уровня (уровня 3) в MAC-адрес канального уровня (уровня 2). Он сопоставляет IP-адрес хоста с соответствующим MAC-адресом, чтобы облегчить связь между устройствами в [локальной сети](https://en.wikipedia.org/wiki/Local_area_network) ( `LAN`). Когда устройство в локальной сети хочет связаться с другим устройством, оно отправляет широковещательное сообщение, содержащее IP-адрес назначения и его собственный MAC-адрес. Устройство с совпадающим IP-адресом отвечает своим собственным MAC-адресом, и затем два устройства могут напрямую взаимодействовать, используя свои MAC-адреса. Этот процесс известен как разрешение ARP.

ARP является важной частью процесса сетевой связи, поскольку он позволяет устройствам отправлять и получать данные, используя MAC-адреса, а не IP-адреса, что может быть более эффективным. Могут использоваться два типа сообщений запроса:

#### ARP Request

Когда устройство хочет связаться с другим устройством в локальной сети, оно отправляет запрос ARP для преобразования IP-адреса устройства назначения в его MAC-адрес. Запрос рассылается всем устройствам в локальной сети и содержит IP-адрес устройства назначения. Устройство с совпадающим IP-адресом отвечает своим MAC-адресом.

#### ARP Reply

Когда устройство получает запрос ARP, оно отправляет ответ ARP запрашивающему устройству с указанием его MAC-адреса. Ответное сообщение содержит IP- и MAC-адреса как запрашивающего, так и отвечающего устройств.

#### Tshark Capture of ARP Requests

MAC-адреса

```shell-session
1   0.000000 10.129.12.100 -> 10.129.12.255 ARP 60  Who has 10.129.12.101?  Tell 10.129.12.100
2   0.000015 10.129.12.101 -> 10.129.12.100 ARP 60  10.129.12.101 is at AA:AA:AA:AA:AA:AA

3   0.000030 10.129.12.102 -> 10.129.12.255 ARP 60  Who has 10.129.12.103?  Tell 10.129.12.102
4   0.000045 10.129.12.103 -> 10.129.12.102 ARP 60  10.129.12.103 is at BB:BB:BB:BB:BB:BB
```

" `who has`Сообщение «в первой и третьей строках указывает, что устройство запрашивает MAC-адрес для указанного IP-адреса, а во второй и четвертой строках отображается ответ ARP с MAC-адресом устройства назначения.

Однако он также уязвим для атак, таких как [ARP Spoofing](https://en.wikipedia.org/wiki/ARP_spoofing) , которые можно использовать для перехвата или манипулирования трафиком в сети. Однако для защиты от таких атак важно внедрить такие меры безопасности, как брандмауэры и системы обнаружения вторжений.

`ARP spoofing`, также известный как `ARP cache poisoning` или `ARP poison routing`, — это атака, которую можно осуществить с помощью таких инструментов, как [Ettercap](https://github.com/Ettercap/ettercap) или [Cain & Abel,](https://github.com/xchwarze/Cain) при которой мы отправляем фальсифицированные сообщения ARP по локальной сети. Цель состоит в том, чтобы связать наш MAC-адрес с IP-адресом законного устройства в сети компании, что позволит нам эффективно перехватывать трафик, предназначенный для законного устройства. Например, это может выглядеть следующим образом:

MAC-адреса

```shell-session
1   0.000000 10.129.12.100 -> 10.129.12.101 ARP 60  10.129.12.100 is at AA:AA:AA:AA:AA:AA
2   0.000015 10.129.12.100 -> 10.129.12.255 ARP 60  Who has 10.129.12.101?  Tell 10.129.12.100
3   0.000030 10.129.12.101 -> 10.129.12.100 ARP 60  10.129.12.101 is at BB:BB:BB:BB:BB:BB
4   0.000045 10.129.12.100 -> 10.129.12.101 ARP 60  10.129.12.100 is at AA:AA:AA:AA:AA:AA
```

Первая и четвертая строки показывают нам ( `10.129.12.100`) отправка фальсифицированных сообщений ARP цели, связывая ее MAC-адрес с ее IP-адресом ( `10.129.12.101`). Вторая и третья строки показывают, что цель отправляет запрос ARP и отвечает на наш MAC-адрес. Это указывает на то, что мы отравили ARP-кэш цели и что весь трафик, предназначенный для цели, теперь будет отправляться на наш MAC-адрес.

Мы можем использовать отравление ARP для выполнения различных действий, таких как кража конфиденциальной информации, перенаправление трафика или запуск MITM-атак. Однако для защиты от подмены ARP важно использовать безопасные сетевые протоколы, такие как IPSec или SSL, а также применять меры безопасности, такие как межсетевые экраны и системы обнаружения вторжений.