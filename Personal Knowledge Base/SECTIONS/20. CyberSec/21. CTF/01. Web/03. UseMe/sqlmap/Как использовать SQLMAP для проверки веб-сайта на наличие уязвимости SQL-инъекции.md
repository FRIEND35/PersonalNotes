
**Что такое SQL-инъекция?**

SQL-инъекция — это метод внедрения кода, при котором злоумышленник выполняет вредоносные SQL-запросы, которые контролируют базу данных веб-приложения. С правильным набором запросов пользователь может получить доступ к информации, хранящейся в базах данных. SQLMAP проверяет, уязвим ли параметр 'GET' для SQL-инъекции. 

Например, рассмотрим следующий фрагмент PHP-кода:

```php
$variable = $_POST['input'];
mysql_query("INSERT INTO `table` (`column`) VALUES ('$variable')");
```

Если пользователь вводит «значение'); DROP TABLE table;–» в качестве входных данных, запрос становится

```php
INSERT INTO `table` (`column`) VALUES('value'); DROP TABLE table;--')
```

что для нас нежелательно, так как здесь пользовательский ввод напрямую компилируется вместе с предварительно написанным SQL-запросом. Следовательно, пользователь сможет ввести SQL-запрос, необходимый для манипулирования базой данных.

SQLMap — это инструмент для тестирования на проникновение с открытым исходным кодом, который автоматизирует процесс обнаружения и эксплуатации уязвимостей SQL-инъекций и захвата серверов баз данных. Это невероятный инструмент, который можно освоить за несколько минут. Он уже включен в AttackBox от THM, или вы можете установить его локально, запустив:

```
git clone --depth 1 <https://github.com/sqlmapproject/sqlmap.git> sqlmap-dev
```

Вот некоторые из наиболее распространенных параметров, которые следует настроить при использовании SQLMap :


Опции:
  
- **--url**:     Укажите URL для атаки
- **--dbms**:   Сообщите SQLMap тип работающей базы данных.
- **--dump**:  Выгрузить данные из базы данных, которую использует приложение.
- **--dump-all**:  Дамп ВСЕЙ базы данных
- **--batch**:  SQLMap запустится автоматически и не будет запрашивать ввод данных пользователем.

**Где можно использовать SQLMAP?**

Если вы видите веб-адрес в виде http://testphp.vulnweb.com/listproducts.php? **cat=1** , где параметр 'GET' выделен жирным шрифтом, то веб-сайт может быть уязвим для этого режима SQL-инъекции, и злоумышленник может получить доступ к информации в базе данных. Кроме того, SQLMAP работает, когда он основан на php.

![[Pasted image 20240731033258.png]]

Простым тестом для проверки уязвимости вашего сайта будет замена значения в параметре запроса get на звездочку `(*)`. Например,

```
http://testphp.vulnweb.com/listproducts.php?cat=*
```

![[Pasted image 20240731033352.png]]

Если это приводит к ошибке, подобной приведенной выше, то мы можем с уверенностью сказать, что веб-сайт уязвим. В этой статье мы воспользуемся веб-сайтом, разработанным с учетом уязвимостей, в демонстрационных целях:

```
http://testphp.vulnweb.com/listproducts.php?cat=1
```

Параметры, которые мы будем использовать для базовой SQL-инъекции, показаны на рисунке выше. Наряду с ними мы также будем использовать параметры –dbs и -u, использование которых было объяснено в Шаге 1.   
**Использование SQLMAP для проверки веб-сайта на уязвимость SQL-инъекции:** 

- **Шаг 1: Перечисление информации о существующих базах данных**   
    Итак, во-первых, нам нужно ввести веб-url, который мы хотим проверить, вместе с параметром -u. Мы также можем использовать параметр –tor, если хотим протестировать веб-сайт с помощью прокси-серверов. Обычно мы хотим проверить, возможно ли получить доступ к базе данных. Поэтому мы используем для этого параметр –dbs. –dbs выводит список всех доступных баз данных.

```
sqlmap -u http://testphp.vulnweb.com/listproducts.php?cat=1 --dbs
```
![[Pasted image 20240731033457.png]]

- Мы получаем следующий вывод, показывающий, что есть две доступные базы данных. Иногда приложение сообщает вам, что оно идентифицировало базу данных и спрашивает, хотите ли вы протестировать другие типы баз данных. Вы можете пойти дальше и ввести «Y». Кроме того, оно может спросить, хотите ли вы протестировать другие параметры на уязвимости, введите «Y» здесь, поскольку мы хотим тщательно протестировать веб-приложение.

![[Pasted image 20240731033508.png]]

- Мы видим, что существуют две базы данных: exact и information_schema.  
- **Шаг 2: Перечислите информацию о таблицах, присутствующих в определенной базе данных**   
    Чтобы попытаться получить доступ к любой из баз данных, нам нужно немного изменить нашу команду. Теперь мы используем -D, чтобы указать имя базы данных, к которой мы хотим получить доступ, и как только у нас будет доступ к базе данных, мы захотим увидеть, можем ли мы получить доступ к таблицам. Для этого мы используем запрос –tables. Давайте получим доступ к точной базе данных.

```
sqlmap -u http://testphp.vulnweb.com/listproducts.php?cat=1 -D acuart --tables
```
![[Pasted image 20240731033535.png]]

- На картинке выше мы видим, что извлечено 8 таблиц. Так что теперь мы точно знаем, что веб-сайт уязвим. 

- **Шаг 3: Перечислите информацию о столбцах конкретной таблицы.** 
    
    Если мы хотим просмотреть столбцы определенной таблицы, мы можем использовать следующую команду, в которой мы используем -T для указания имени таблицы и –columns для запроса имен столбцов. Мы попытаемся получить доступ к таблице 'artists'.

```
sqlmap -u http://testphp.vulnweb.com/listproducts.php?cat=1 -D acuart -T artists --columns
```

![[Pasted image 20240731033603.png]]

- **Шаг 4: Выгрузите данные из столбцов**   
    Аналогичным образом мы можем получить доступ к информации в определенном столбце, используя следующую команду, где -C можно использовать для указания нескольких имен столбцов, разделенных запятой, а запрос –dump извлекает данные.

```
sqlmap -u http://testphp.vulnweb.com/listproducts.php?cat=1 -D acuart -T artists -C aname --dump
```

![[Pasted image 20240731033634.png]]

- Из рисунка выше мы видим, что мы получили доступ к данным из базы данных. Аналогично, на таких уязвимых веб-сайтах мы можем буквально исследовать базы данных, чтобы извлечь информацию  

**Предотвращение SQL-инъекций**

SQL-инъекцию можно предотвратить, используя **Prepared Statements** . Когда мы используем подготовленный оператор, мы в основном используем шаблон для кода и анализируем код и пользовательский ввод отдельно. Он не смешивает введенный пользователем запрос и код. В примере, приведенном в начале этой статьи, вводимые пользователем данные напрямую вставляются в код, и они компилируются вместе, и, следовательно, мы можем выполнить вредоносный код. Для подготовленных операторов мы в основном отправляем SQL-запрос с заполнителем для пользовательского ввода, а затем отправляем фактический пользовательский ввод как отдельную команду.   
Рассмотрим следующий сегмент PHP-кода.

```php
$db = new PDO('connection details');
$stmt = db->prepare("Select name from users where id = :id");
$stmt->execute(array(':id', $data));
```

В этом коде пользовательский ввод не объединяется с подготовленным оператором. Они компилируются отдельно. Поэтому даже если вредоносный код вводится как пользовательский ввод, программа просто будет обрабатывать вредоносную часть кода как строку, а не как команду. 

**Примечание: данное приложение предназначено исключительно для целей тестирования.**

**Сопутствующая статья**   
[Базовая SQL-инъекция и ее устранение](https://www.geeksforgeeks.org/basic-sql-injection-mitigation-example/) 

**Ссылка:** stackoverflow.com

---

Давайте покажем пример команды SQLMap. Допустим, у нас есть уязвимая форма входа, расположенная по адресу " [http://tbfc.net/login.php](http://notarealwebsite.com/login.php) ". ( **Обратите внимание, что это всего лишь пример, пожалуйста, не применяйте SQLMap к этому веб-сайту, так как владелец не давал на это согласия.** ) Мы будем использовать это вместе с тем `--url`, чтобы указать SQLMap , где следует проводить атаку. т.е.`sqlmap --url http://tbfc.net/login.php`

Где мы затем можем перейти к перечислению данных, которые находятся в базе данных приложения, с такими опциями, как `--tables`и `--columns`. Оставив наш окончательный SQLMap выглядящим следующим образом:`sqlmap --url http://tbfc.net/login.php --tables --columns`

**Опять же, tbfc.net приведен в качестве примера, пожалуйста, не совершайте никаких атак на этот сайт.**

- Шпаргалку с дополнительными фрагментами команд SQLMap можно найти [здесь.](https://www.security-sleuth.com/sleuth-blog/2017/1/3/sqlmap-cheat-sheet)


Если вы видите веб-адрес в виде http://testphp.vulnweb.com/listproducts.php? **cat=1** , где параметр 'GET' выделен жирным шрифтом, то веб-сайт может быть уязвим для этого режима SQL-инъекции, и злоумышленник может получить доступ к информации в базе данных. Кроме того, SQLMAP работает, когда он основан на php.

## **Как использовать карту SQL**

SQLMap — это инструмент, используемый для автоматизированной эксплуатации уязвимостей SQL-инъекций. Мы можем использовать SQLMap для проверки веб-сайтов и баз данных на наличие уязвимостей и использовать эти уязвимости для захвата базы данных.

Чтобы использовать SQLMap, нам сначала нужно определить веб-сайт или базу данных, уязвимые для SQL-инъекции. Мы можем сделать это вручную или использовать SQLMap для сканирования веб-сайта. После того, как мы определили уязвимый веб-сайт или базу данных, мы можем использовать SQLMap для его эксплуатации.

Вот основная команда SQLMap:

```
sqlmap -u [URL] -p [parameter] --dbs
```

Эта команда сообщит SQLMap о необходимости сканирования указанного URL и параметра на предмет уязвимостей. Это включает в себя раскрытие данных, обновление данных или даже сброс всей базы данных.

Самый простой способ проверить, уязвим ли веб-сайт для SQL-инъекции, — это параметры запроса. Предположим, что веб-сайт перечисляет информацию о пользователе с помощью параметра id, например, testsite.com/page.php?id=1.

Это можно передать в качестве входных данных в SQLMap, и SQLMap автоматически просканирует сайт, чтобы проверить, уязвима ли база данных. Вот команда:

```
sqlmap -u http://testsite.com/page.php?id=1 --dbs
```

Флаг `-u`используется для указания URL-адреса, а `--dbs`команда сообщает SQLMap о необходимости попытаться перечислить базу данных.

Если атака прошла успешно, SQLMap выведет список использованной базы данных вместе со списком таблиц.


![[Pasted image 20240731022241.png]]

После того, как мы получили начальную точку опоры, мы можем теперь работать с базой данных. Вот команда для вывода списка таблиц в базе данных.

```
sqlmap -u https://testsite.com/page.php?id=1 -D <db_name> --tables
```

Чтобы вывести список столбцов в таблице, мы можем использовать эту команду:

```
sqlmap -u https://testsite.com/page.php?id=7 -D <database_name> -T <table_name> --columns
```

Чтобы сделать дамп всей базы данных, используйте следующую команду:

```
sqlmap -u https://testsite.com/page.php?id=7 -D <database_name> --dump-all
```

SQLMap предоставляет множество других полезных команд, таких как настройка файлов cookie, циклическое переключение пользовательских агентов и многое другое. Для получения дополнительной информации и полного списка опций вы можете [обратиться к документации SQLMap](https://github.com/sqlmapproject/sqlmap/wiki/Introduction) .

## Как защититься от атак SQL-инъекций

Чтобы предотвратить атаки с использованием SQL-инъекций, необходимо выполнить следующие действия:

### Используйте параметризованные запросы

Всегда используйте параметризованные запросы при взаимодействии с базой данных. Это означает, что мы должны использовать заполнители в наших SQL-выражениях для любого пользовательского ввода. Затем мы можем предоставить ввод в качестве отдельного параметра при выполнении запроса.

Это не позволит злоумышленнику внедрить произвольный SQL-код в наши SQL-операторы.

### Никогда не доверяйте пользовательскому вводу

Мы всегда должны проверять и дезинфицировать любой пользовательский ввод, чтобы гарантировать его безопасность. Мы должны убедиться, что ввод не содержит опасных символов или вредоносного кода.

Это поможет предотвратить возможность злоумышленника внедрять SQL-запросы, даже если ему удастся обойти наше использование параметризованных запросов.

### Используйте подготовленные заявления

Если база данных поддерживает подготовленные операторы, следует использовать их вместо параметризованных запросов.

Подготовленные операторы — это предварительно скомпилированные операторы SQL. Мы можем выполнять эти операторы несколько раз с разными параметрами.

Это затруднит злоумышленнику внедрение вредоносного кода, поскольку подготовленные операторы предварительно скомпилированы.

### Аутентификация и контроль доступа

Мы должны иметь надежную аутентификацию и контроль доступа к нашей базе данных. Это гарантирует, что только авторизованные пользователи смогут получить доступ к нашей базе данных и защитит ее от злоумышленников.

### Мониторинг и оповещения

Всегда следите за своей базой данных на предмет подозрительной активности и устанавливайте оповещения. Это включает в себя неудачные попытки входа или большое количество SQL-запросов.

Это может помочь нам обнаружить атаку путем внедрения SQL-кода на ранней стадии и принять соответствующие меры для ее предотвращения.

## Краткое содержание

Базы данных являются основой любого бизнеса. Обновление, обслуживание и обеспечение безопасности баз данных имеет важное значение для их защиты от злоумышленников.

SQLmap — мощный инструмент, который помогает нам проводить аудит уязвимостей баз данных. Разработчикам и специалистам по безопасности важно знать SQLMap для защиты от атак с использованием SQL-инъекций.
