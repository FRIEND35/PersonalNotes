Сегодня я расскажу, что такое Server-side template injection на практике. Я покажу, как найти эту уязвимость и раскрутить ее до выполнения кода на сервере. Также ты узнаешь, почему выплаты за эту уязвимость на BugBounty доходят до $10000. Может показаться, что уязвимость сложная в эксплуатации, но это не так. Есть много деталей, но в целом ее достаточно просто найти и раскрутить. Ну что погнали? Разберем еще одну интересную уязвимость.

#### Что такое Server-side template injection?

> **Server-side template injection (SSTI)** — это уязвимость внедрения вредоносного кода в шаблон с последующим выполнением на стороне сервера. Многие сайты используют разнообразные шаблоны для более стильного/динамичного отображения страниц, а также для создания подготовленных ответов для пользователей.

Например, при смене пароля, на почту придет вот такое уведомление: "Username, ваш пароль был изменен". Это тоже является шаблоном, так как это сообщение отправляется всем пользователям, но только с разным параметром username. Если хакер с помощью синтаксиса шаблона смог передать полезную нагрузку и она выполнилась на стороне сервера — приложение уязвимо к SSTI.

Риск и последствия напрямую зависят от функционала движка. Иногда SSTI позволяет выполнить произвольный код на сервере и получить полный доступ на сервере. Даже если в движке есть определенные ограничения и нет возможности выполнять код на стороне сервера, с помощью SSTI можно проводить другие атаки, которые могут привести к утечке конфиденциальной информации. Давай посмотрим на конкретном примере. Например, у нас есть функционал интернет-магазина, который дублирует содержание заказа. Примерно в таком стиле:

> "Привет, <username>. Твой заказ на сумму <order_sum> был оформлен. Ожидайте доставки с 30.07."

Существующий шаблон меняет параметры <username> и <order_sum> под конкретного пользователя и сумму заказа соответственно. А что будет если зарегистрировать пользователя с никнеймом 5*5 или {{5*5}}. Если шаблон сконфигурирован неправильно, то при следующем заказе можем увидеть следующее:

> "Привет, 25. Твой заказ на сумму 1037 рублей был оформлен. Ожидайте доставки с 30.07."

Таким образом, видим выполнение кода в параметре <username> на стороне сервера посредством SSTI. На более конкретном примере, я покажу как можно раскрутить эту уязвимость и получить произвольное выполнение кода.



# Как найти SSTI?

Нужно найти место, где данные возвращаются в ответе. Это может быть онлайн-форма, страница заказа, профайл и т.д. После этого нужно попробовать добавить разные SSTI пейлоады и получить ошибку или выполнение кода. Если получаем, ответ как в примере, то получаем гарантированную SSTI.

```
User=Hello ${7*7}
Hello 49
```

Когда неправильно построено выражение могут вылетать ошибки. Это тоже может "намекать" на SSTI. Примерно вот такой вывод можно получить от Ruby движка ERB:

```
(erb):1:in `<main>': undefined local variable or method `foobar' for main:Object (NameError)
from /usr/lib/ruby/2.5.0/erb.rb:876:in `eval'
from /usr/lib/ruby/2.5.0/erb.rb:876:in `result'
from -e:4:in `<main>'
```

Дальше нужно определить, что за движок используется среди существующих шаблонов FreeMarker, Velocity, Smarty, Twig, Twig (sandboxed) и Jade. Есть картинка-подсказка, которая позволяет определить названия шаблона по результатам выполнения. Тут самые популярные варианты, в случае есть какие-то другие ошибки, гугл в помощь.

![[Pasted image 20230212145826.png]]

# Эксплуатируем реальную SSTI

Раскрутим SSTI на практике. Представим, что у нас есть интернет-магазин и при переходе на одну из страниц вот такой запрос в URL:

https://internetshop.com/?message=Object is not found 

Дальше пытаемся передать параметр, и получить отображение результата на странице.

https://internetshop.com/?message=SSTI

После чего на странице появляется надпись SSTI. Отлично, потенциально мы нашли SSTI. Нужно разобраться, что за шаблон и получить выполнение кода на стороне сервера. Дальше загружаем весь список потенциальный пейлоадов и анализируем ответ. Автоматизировать можно с помощью BurpSuite Intruder. Список моих пейлоадов можно посмотреть на скриншоте, по [ссылке](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#methodology) есть более детальный список ко всем движкам.

![[Pasted image 20230212145839.png]]


Получаем ответ, что сработал пейлоад <%= 7*7 %> и на странице отображается выполненный результат 49. Для проверки можно вставить наш пейлоад в запрос и посмотреть на странице. Сам пейлоад будет закодирован с помощью URL-encode.

https://internetshop.com/?message=%3c%%3d%207%2a7%20%%3e

Далее, находим что пейлоад "<%= 7*7 %>" — синтаксис движка ERB. Ищем пейлоад для выполнения системных команд:

<%= system("cat /etc/passwd") %>
https://internetshop.com/?message=<%= system("cat /etc/passwd") %>

Выполним URL-encode и наш финальный пейлоад будет выглядеть:

https://internetshop.com/?message=%3c%25%3d%20%73%79%73%74%65%6d%28%22%63%61%74%20%2f%65%74%63%2f%70%61%73%73%77%64%22%29%20%25%3e

![[Pasted image 20230212145859.png]]

Мы получили выполнения кода на стороне сервера посредством SSTI. На скриншоте выше содержание файла /etc/passwd. Дальше, можно получить шелл или прочитать содержимое некоторых других файлов. Все зависит от целей и заданий.



# Сколько платят BugBounty за SSTI?

SSTI не так часто встречаются в отчетах BugBounty программ. Вознаграждение находиться в диапазоне от 1000-10000 долларов. Максимальные выплаты присваиваются для Server-side template injection, которые приводят к удаленному выполнению кода. Именно таких два примера разберем в этой статье.

Первый [пример](https://hackerone.com/reports/125980) был найден в bugbounty программе Uber. Пользователь с ником Orange сменил свой ник на сайте uber.com на {{'7'*7}} и в письме получил "77777777". Это говорит о том, что система уязвима к SSTI (Jinja2 шаблон). За эту уязвимость хакер получил $10000 вознаграждение

![[Pasted image 20230212145913.png]]

Второй [пример](https://hackerone.com/reports/423541) был найден в программе компании Shopify. Эксплуатация намного сложнее первого примера. Пользователь пытался модифицировать стандартный шаблон отправки и смог получить изменение шаблона и получения дополнительной информации. Такая находка принесла хакеру $10000.

![[Pasted image 20230212145926.png]]




# Заключение

Server-side template injection достаточно серьёзная уязвимость. Через SSTI можно получить полный контроль над сервером, что мы сегодня и разбирали на конкретных примерах. Движки шаблонов будут и дальше активно набирать популярность. Поэтому потенциально можно будет встретить еще больше репортов с багбаунти платформ.