"## Введение

В сегодняшней цифровой среде данные являются ценным активом. От платформ электронной коммерции до систем здравоохранения — базы данных хранят огромное количество информации. Именно здесь проявляется важность SQL (языка структурированных запросов), выступающего в качестве универсального языка для взаимодействия с базами данных. Однако это удобство также может быть использовано злоумышленниками посредством атак с использованием SQL-инъекций.

## Понимание SQL-инъекций

SQL-инъекция, по своей сути, включает в себя манипулирование полями ввода веб-приложения для выполнения непреднамеренных SQL-запросов. Эти запросы могут обеспечить несанкционированный доступ к базе данных, извлечь конфиденциальную информацию, изменить данные или даже удалить целые наборы данных. Это происходит, когда приложение неправильно проверяет или очищает вводимые пользователем данные перед созданием SQL-запросов. В результате злоумышленники могут внедрить вредоносный код SQL, заставляя базу данных выполнять непредвиденные действия.

## Типы SQL-инъекций

1. Классическая SQL-инъекция: этот тип возникает, когда злоумышленник вставляет вредоносный код SQL в поля ввода приложения. Например, рассмотрим форму входа, в которой пользователь должен ввести свое имя пользователя и пароль. Злоумышленник может ввести `' OR '1'='1`имя пользователя, в результате чего запрос вернет true и предоставит несанкционированный доступ.

1. Слепая SQL-инъекция. В этом сценарии злоумышленники используют уязвимости, не видя непосредственно результата своих действий. Используя утверждения «истина-ложь», злоумышленники определяют структуру базы данных и извлекают конфиденциальную информацию.

1. Слепая SQL-инъекция на основе времени: злоумышленники вводят временные задержки в SQL-запросы и наблюдают за временем ответа приложения, чтобы сделать вывод, является ли внедренный запрос истинным или ложным. Это позволяет им собирать информацию косвенным путем.

1. SQL-инъекция на основе объединения: используя оператор SQL UNION, злоумышленники объединяют результаты нескольких операторов SELECT. Это помогает им извлекать информацию из разных таблиц базы данных.

1. SQL-инъекция на основе ошибок. Злоумышленники намеренно вызывают ошибки в SQL-запросах, чтобы раскрыть информацию о схеме и структуре базы данных. Эта информация может быть использована для дальнейшего компрометации системы.

## Предотвращение SQL-инъекций

1. Проверка ввода. Внедрите строгие механизмы проверки ввода, которые фильтруют и очищают вводимые пользователем данные. Это не позволяет злоумышленникам внедрить вредоносный код.

1. Параметризованные операторы. Используйте параметризованные запросы или подготовленные операторы, которые отделяют ввод пользователя от запроса SQL. Это сводит к минимуму риск инъекционных атак.

1. Брандмауэры веб-приложений (WAF): используйте WAF для мониторинга и фильтрации входящего трафика, выявления и блокировки потенциальных попыток внедрения SQL.

1. Принцип наименьших привилегий: Ограничьте привилегии пользователя базы данных минимумом, необходимым для операций. Это снижает потенциальный ущерб от успешных атак.

1. Регулярные проверки безопасности. Проводите регулярные проверки безопасности для выявления и устранения уязвимостей, обеспечивая надежность вашей защиты.

## Как работает атака SQLi ?

SQLi выполняется посредством злоупотребления параметром PHP GET (например, **?username=** или **?id=** ) в URL-адресе уязвимой веб-страницы, например, тех, что рассмотрены в День 2. Обычно они находятся в полях поиска и на страницах входа в систему, поэтому вам, как тестировщику на проникновение, необходимо их записать.

Вот пример поля ввода имени пользователя, написанного на PHP :

```
<?php $username = $_GET['username']; $result = mysql_query("SELECT * FROM users WHERE username='$username'"); ?>
```

После того, как переменная `username`была введена в код, PHP автоматически использует SQL для выбора всех пользователей с указанным именем пользователя. Именно этот факт может быть использован злоумышленником.

Допустим, злонамеренный пользователь вводит кавычки ( **'** ) в качестве имени пользователя. Тогда код SQL будет выглядеть следующим образом:

```
SELECT * FROM users WHERE username='''
```

Как вы видите, эта метка создает третью и генерирует ошибку, поскольку имя пользователя должно быть указано только с двумя. Именно эта ошибка используется для эксплуатации SQL- инъекции.

В общем случае SQL-инъекция — это атака, при которой ваша цель — нарушить логику выполнения SQL-кода, внедрить свою собственную, а затем «исправить» сломанную часть, добавив комментарии в конце.


![[Pasted image 20240729130619.png]]

Графическая интерпретация

Наиболее часто используемые комментарии для полезных нагрузок SQLi :

```
--+ // /*
```

## Обход входа с помощью SQL- инъекции

Одно из самых мощных применений SQL- инъекции — это, безусловно, обход входа в систему. Он позволяет злоумышленнику получить доступ к **ЛЮБОЙ** учетной записи, если он знает либо имя пользователя, либо пароль к ней (чаще всего вы знаете только имя пользователя).

Сначала давайте выясним причину, по которой это возможно. Допустим, наше приложение для входа использует PHP для проверки соответствия имени пользователя и пароля базе данных с помощью следующего SQL- запроса:

```
SELECT username,password FROM users WHERE username='$username' and password='$password'
```

Как вы видите, запрос использует введенные имя пользователя и пароль для проверки его в базе данных.

Что произойдет, если мы введем `' or true --`туда поле имени пользователя? Это превратит приведенный выше запрос в следующий:

```
SELECT username,password FROM users WHERE username='' or true -- and password=''
```

В `--`этом случае закомментирована часть проверки пароля, из-за чего приложение забывает проверить правильность пароля. Этот трюк позволяет вам войти в любую учетную запись, просто поместив имя пользователя и полезную нагрузку сразу после него.

Обратите внимание, что некоторые веб-сайты могут использовать другой SQL- запрос, например:

```
SELECT username,pass FROM users WHERE username=('$username') and password=('$password')
```

В этом случае вам придется добавить одну скобку к вашей полезной нагрузке, вот так: `') or true–`чтобы все заработало.

Вы можете попрактиковаться в обходе входа на развернутой машине, порт 3000 (сначала перейдите на , `MACHINE_IP:3000/init.php`а затем на `MACHINE_IP:3000`). Я поместил там дополнительное интерактивное упражнение. Оно покажет вам весь вывод бэкенда, что позволит вам экспериментировать и практиковаться с командами SQL .

## Слепая SQL- инъекция

В некоторых случаях разработчики становятся достаточно умными, чтобы смягчить SQL- инъекцию, ограничивая приложение от отображения любой ошибки. К счастью, это не означает, что мы не можем выполнить атаку.  
Слепая SQL- инъекция опирается на изменения в веб-приложении во время атаки. Другими словами, ошибка в SQL- запросе будет заметна в какой-то другой форме (например, измененное содержимое или другое).

Поскольку в этой ситуации мы можем только увидеть, была ли произведена ошибка или нет, слепой SQLi выполняется путем задавания вопросов «Да» или «Нет» базе данных (Ошибка = «Нет», Нет ошибки = «Да»).  
С помощью этой системы злоумышленник может угадать имя базы данных, прочитать столбцы и т. д. Слепой SQLi займет больше времени, чем другие типы, но может быть наиболее распространенным в дикой природе.

Начните с поиска способа вызвать ошибку SQL , а затем исправьте ее.


![[Pasted image 20240729130641.png]]

Взлом приложения

![[Pasted image 20240729130653.png]]

Исправление — Обратите внимание, что приложение не вывело никаких ошибок, хотя я явно вызвал ошибку SQL .

Для того, чтобы задать вопросы, вы можете использовать функцию SQL [SUBSTR()](https://www.w3schools.com/sql/func_mysql_substr.asp) . Она извлекает подстроку из строки и позволяет нам сравнивать подстроку с пользовательским символом ASCII.

```
substr((select database()),1,1)) = 115
```

Приведенный выше код запрашивает у базы данных, равна ли первая буква ее имени числу 155 («s» в таблице [ASCII](https://external-content.duckduckgo.com/iu/?u=http%3A%2F%2Fstatic.arcbotics.com%2Fwp-content%2Fuploads%2F2014%2F01%2FASCII-Table.gif&f=1&nofb=1) ).

Теперь поместите это в полезную нагрузку:

```
?id=1' AND (ascii(substr((select database()),1,1))) = 115 --+
```

Полезная нагрузка — вот в чем вопрос. Если приложение не производит никаких изменений, то ответ — «Да» (первая буква базы данных — «s»). Любая ошибка или изменение = «Нет».

![[Pasted image 20240729130707.png]]

_Примечание: Вы также можете использовать методы слепого внедрения SQLi в «открытой» ситуации._

## SQL- инъекция UNION

UNION SQLi в основном используется для быстрого перечисления баз данных, поскольку оператор UNION позволяет объединять результаты нескольких операторов SELECT одновременно.

**Атака** UNION SQLi   состоит из 3 этапов:

1. Нахождение количества столбцов
2. Проверка пригодности колонок
3. Атакуйте и получите интересные данные.

- Определение количества столбцов, необходимых для атаки UNION с использованием SQL- инъекции

Есть два способа обнаружить его:

Первый вариант подразумевает внедрение серии запросов ORDER BY до тех пор, пока не возникнет ошибка. Например:

```
' ORDER BY 1-- ' ORDER BY 2-- ' ORDER BY 3-- # and so on until an error occurs
```

(Последнее значение перед ошибкой будет указывать количество столбцов.)

Второй способ (наиболее распространенный и эффективный) предполагает отправку серии полезных нагрузок UNION SELECT с рядом значений NULL:

```
' UNION SELECT NULL-- ' UNION SELECT NULL,NULL-- ' UNION SELECT NULL,NULL,NULL-- # until the error occurs
```

Ошибки нет = количество NULL совпадает с количеством столбцов.

- Поиск столбцов с полезным типом данных в атаке UNION с использованием SQL- инъекции

Как правило, интересные данные, которые вы хотите получить, будут в строковой форме. Уже определив количество требуемых столбцов (например, 4), вы можете проверить каждый столбец, чтобы проверить, может ли он содержать строковые данные, заменив одну из полезных нагрузок UNION SELECT строковым значением. В случае 4 вы должны отправить:

```
' UNION SELECT 'a',NULL,NULL,NULL-- ' UNION SELECT NULL,'a',NULL,NULL-- ' UNION SELECT NULL,NULL,'a',NULL-- ' UNION SELECT NULL,NULL,NULL,'a'--
```

Ошибки нет = тип данных полезен для нас (строка).

- Использование атаки UNION с SQL- инъекцией для извлечения интересных данных

Определив количество столбцов и выяснив, какие столбцы могут содержать строковые данные, вы, наконец, можете приступить к извлечению интересных данных.

Предположим, что:

- Первые два шага показали ровно два существующих столбца с полезным типом данных.
- База данных содержит таблицу с именем «пользователи» со столбцами «имя пользователя» и «пароль».

В этой ситуации вы можете получить содержимое таблицы пользователя, отправив входные данные:

```
' UNION SELECT username, password FROM users --
```

Вот небольшой список того, что вам хотелось бы получить:

1. database()
2. user()
3. @@version
4. username
5. password
6. table_name
7. column_name

## Заключение

В эпоху цифровых технологий защита конфиденциальных данных не подлежит обсуждению. SQL-инъекция является свидетельством меняющегося ландшафта угроз и напоминает нам о важности превентивных мер безопасности. Понимая типы SQL-инъекций и реализуя эффективные профилактические стратегии, организации могут защитить свои приложения и базы данных от этих вредоносных атак.

## Часто задаваемые вопросы (FAQ)

1. Что делает SQL-инъекцию серьезной угрозой для веб-приложений? SQL-инъекция может привести к несанкционированному доступу, утечке данных и даже завершению работы системы, что представляет собой серьезную угрозу безопасности веб-приложений.
2. Существуют ли реальные примеры атак с использованием SQL-инъекций? Да, примечательные примеры включают взлом Yahoo в 2014 году и печально известный инцидент с Equifax в 2017 году, оба из которых использовали уязвимости внедрения SQL.
3. Какую пользу злоумышленники получают от атак со слепым внедрением SQL? Злоумышленники используют слепое внедрение SQL-кода для сбора информации о структуре базы данных, что помогает им планировать последующие атаки.
4. Разве брандмауэры сами по себе не могут предотвратить атаки с использованием SQL-инъекций? Хотя брандмауэры веб-приложений могут помочь обнаружить и предотвратить некоторые попытки внедрения SQL-кода, их следует использовать в сочетании с другими методами обеспечения безопасности для комплексной защиты.
5. Какова роль обучения пользователей в предотвращении атак с использованием SQL-инъекций? Обучение пользователей необходимо для предотвращения атак социальной инженерии, которые могут привести к непреднамеренному внедрению SQL. Образованные пользователи с большей вероятностью будут избегать действий, которые могут поставить под угрозу безопасность.