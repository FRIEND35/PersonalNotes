

Источник:   https://owasp.org

Ссылка:       https://owasp.org/www-community/attacks/Format_string_attack


## Описание

Эксплойт Format String происходит, когда отправленные данные ввода string оценивается приложением как команда. Таким образом, злоумышленник может выполнить код, прочитать стек или вызвать сегментацию сбой в работающем приложении, вызывающий новое поведение, которое может поставить под угрозу безопасность или стабильность системы.

Чтобы понять атаку, необходимо понять компоненты которые его составляют.

• **Функция форматирования** представляет собой функцию преобразования ANSI C, например **printf, fprintf** , который преобразует примитивную переменную языка программирования в удобочитаемое строковое представление.

• **Строка формата** является аргументом функции формата и Строка ASCII Z, содержащая параметры текста и формата, например: **printf («Магическое число: %d\n», 1911 г.)** ;

• **Параметр строки формата** , такой как **%x %s,** определяет тип преобразование функции формата.

Атака может быть выполнена, когда приложение неправильно подтвердить отправленный ввод. В этом случае, если строка формата параметр, например %x, вставляется в публикуемые данные, строка анализируется функцией форматирования, и преобразование, указанное в параметры выполняются. Однако функция форматирования ожидает большего. аргументы в качестве входных данных, и если эти аргументы не предоставлены, функция может читать или записывать стек.

Таким образом, можно определить хорошо обработанный ввод, который мог бы изменить поведение функции форматирования, позволяя злоумышленнику вызывать отказ в обслуживании или выполнять произвольные команды.

Если приложение использует функции форматирования в исходном коде, что способный интерпретировать символы форматирования, злоумышленник может исследовать уязвимость путем вставки символов форматирования в форму Веб-сайт. Например, если **функция printf** используется для печати имя пользователя, вставленное в некоторые поля страницы, сайт может быть уязвимы для такого рода атак, как показано ниже:

```
printf (userName);
```

Ниже приведены некоторые примеры функций формата, которые, если их не обрабатывать, может подвергнуть приложение атаке Format String.

**Таблица 1. Функции формата**

|Функция формата|Описание|
|---|---|
|fprintf|Записывает printf в файл|
|printf|Вывести форматированную строку|
|sprintf|Печатает в строку|
|snprintf|Печатает в строку, проверяя длину|
|vfprintf|Печатает структуру va_arg в файл|
|vprintf|Выводит структуру va_arg на стандартный вывод|
|vsprintf|Печатает va_arg в строку|
|vsnprintf|Печатает va_arg в строку, проверяя длину|

Ниже приведены некоторые параметры формата, которые можно использовать, и их последствия:

• «%x» Чтение данных из стека

• «%s» Чтение строк символов из памяти процесса

• «%n» Записать целое число в ячейки памяти процесса.

Чтобы узнать, уязвимо ли приложение для этого типа атаки, необходимо проверить, принимает ли функция форматирования и анализирует параметры строки формата, показанные в таблице 2.

**Таблица 2. Общие параметры, используемые в атаке на строку формата.**

```
Параметры 	Выход 	                                    Принято как

%%         	% символ (буквальный) 	                    Ссылка
%p      	Внешнее представление указателя на void 	Ссылка
%d      	Десятичная дробь 	                        значение
%с 	        символ 	 
%u 	        Беззнаковое десятичное число 	            значение
%x 	        шестнадцатеричный 	                        значение
%s 	        Строка 	                                    Ссылка
%n 	        Записывает количество символов в указатель 	Ссылка 
```



## Пример

```c
#include  <stdio.h> 
void main(int argc, char **argv)
{
	// This line is safe
	printf("%s\n", argv[1]);

	// This line is vulnerable
	printf(argv[1]);
}
```

### Безопасный код

Линия `printf("%s", argv[1]);`в примере безопасно, если скомпилировать программу и запустить ее:

`./example "Hello World %s%s%s%s%s%s"`

The `printf`в первой строке не будет интерпретировать «%s%s%s%s%s%s» во входной строке, и вывод будет: «Hello World %s%s%s%s%s%s»

### Уязвимый код

Линия `printf(argv[1]);`в примере уязвим, если вы скомпилируете программу и запустите ее:

`./example "Hello World %s%s%s%s%s%s"`

The `printf`во второй строке будет интерпретировать `%s%s%s%s%s%s`во входной строке как ссылку на указатели строк, поэтому он будет пытаться интерпретировать каждый %s как указатель на строку, начиная с местоположения буфера (возможно, в стеке). В какой-то момент он попадет на недопустимый адрес, и попытка доступа к нему приведет к сбою программы.

### Различные полезные нагрузки

Злоумышленник также может использовать это для получения информации, а не только для сбоя программного обеспечения. Например, запуск:

`./example "Hello World %p %p %p %p %p %p"`

Напечатает строки:

```
Hello World %p %p %p %p %p %p
Hello World 000E133E 000E133E 0057F000 CCCCCCCC CCCCCCCC CCCCCCCC
```

Первая строка выводится из неуязвимой версии `printf`, и вторая строка от уязвимой строки. Значения, напечатанные после текста «Hello World», — это значения в стеке моего компьютера на момент запуска этого примера.

Также в некоторых условиях возможны чтение и запись в любую ячейку памяти и даже выполнение кода.

Для получения дополнительной информации см. [статью «Использование уязвимостей форматных строк»](https://cs155.stanford.edu/papers/formatstring-1.2.pdf) ​​от 2001 года.

### Аналогичные функции для printf

Все семейство функций printf уязвимо. Вот пример snprintf:

```
#include  <stdio.h>
void main(int argc, char **argv)
{
	char buf[100];
	snprintf(buf, sizeof buf, argv[1]);
}
```

Запуск этой программы следующим образом приведет к сбою.

`./example "Hello World %s%s%s%s%s%s"`

Безопасным использованием snprintf будет:

`snprintf(buf, sizeof buf, "%s", argv[1]);`

## Связанные агенты угроз

- подрядчики
- внутренний разработчик программного обеспечения

## Связанные [атаки](https://owasp.org/www-community/attacks/)

- [Внедрение кода](https://owasp.org/www-community/attacks/Code_Injection)

## Связанные [уязвимости](https://owasp.org/www-community/vulnerabilities/)

- [Переполнение буфера](https://owasp.org/www-community/attacks/Buffer_Overflow)

## Связанные [элементы управления](https://owasp.org/www-community/controls/)

- [:Category:Проверка ввода](https://owasp.org/www-community/attacks/:Category:Input_Validation "викиссылка")

## Рекомендации

- [http://www.webappsec.org/projects/threat/classes/format_string_attack.shtml](http://www.webappsec.org/projects/threat/classes/format_string_attack.shtml)
- [http://en.wikipedia.org/wiki/Format_string_attack](https://en.wikipedia.org/wiki/Format_string_attack)
- [http://seclists.org/bugtraq/2005/Dec/0030.html](http://seclists.org/bugtraq/2005/Dec/0030.html)
- [https://cs155.stanford.edu/papers/formatstring-1.2.pdf](https://cs155.stanford.edu/papers/formatstring-1.2.pdf)

[Категория:Инъекции](https://owasp.org/www-community/Injection_Flaws)