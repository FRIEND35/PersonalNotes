

Возможно, вы регулярно выполняете замену строк через переменные в своем коде. Для эффективного и безопасного использования вставки строк недостаточно понимать ее функциональные возможности. Также требуется знание случаев или возможностей уязвимости.

Например, самая распространенная угроза для программ на C и многих других языках программирования — атака форматной строки — может помешать программе ответить. Прочтите этот пост, чтобы узнать больше об уязвимости форматной строки, методах ее работы и методах предотвращения.

# Что такое уязвимость строки формата?  

Часто встречается в программах на языке C и относится к ошибке в функции printf(). Он широко используется для передачи данных, которые могут быть текстовыми строками ASCII, на стандартный вывод. При правильном использовании текстовые строки могут привести к эффективным и автоматизированным типам преобразования. Наоборот, неправильная конфигурация приводит к проблеме.

Атака форматной строки проявляется, когда данные, которые предоставляет входная строка printf(), рассматриваются или выполняются программным обеспечением как команда. Когда это происходит, злоумышленник может легко вставить вредоносный код во входную строку или стек доступа и даже вызвать временный или постоянный сбой выполнения программного обеспечения.

В зависимости от серьезности атаки может привести к ненормальному поведению системы и неработоспособности системы. Чаще всего неправильное использование %d и %s в строке print() приводит к успеху.

Эта угроза может затронуть наиболее распространенные члены семейства функций printf: fprintf, vsprintf, vsnprintf, sprint и vfprintf.

# Строка формата Уязвимости в действии — пример

Вот пример кода:

```c
#include <stdio.h>

int main(int arg1, char **arg2){

printf(arg2[1]);

}
```

Теперь в этом коде нет определенного спецификатора формата, который позволил бы злоумышленнику вставить спецификатор формата по своему выбору. Чтобы избежать этой проблемы, более безопасной альтернативой может быть переписывание этого оператора printf следующим образом:

```c
printf(“%s”, arg2[1]);
```

Здесь присутствует спецификатор формата %s. Так что возможности для атаки нет.

## Исторические данные

Tymm Twillman была первой, кто заметил возможности форматов входных строк в сентябре 1999 года. Это произошло, когда она активно участвовала в аудите безопасности ProFTPD, сервера на основе программирования C. Во время аудита он обнаружил функцию printf(), в которой отсутствовала точная строка, что приводило к передаче данных, созданных пользователем, на сервер.

Чтобы лучше понять этот инцидент, он провел тщательное тестирование всех доступных функций печати и пришел к выводу, что лазейка, связанная со строками, может привести к множеству угроз. Используя его, злоумышленники могут получить привилегии, или root-доступ к системе может привести к сбоям в работе.

## Причиненный ущерб

Если существующая лазейка в кибербезопасности строкового формата останется незамеченной в течение длительного времени, она может породить множество угроз. Например:

- Неожиданный сбой кода
- Несанкционированный доступ к данным стека
- Выполнение произвольного кода для приложения
- Успешный отказ в обслуживании (DoS).


## Уязвимости строки формата для различных типов программ

### Код написан на C

C принимает несколько типов аргументов для печати вывода. Он становится уязвимым, когда управляемая пользователем программа получает преднамеренный или непреднамеренный ввод, нарушая код.

Строка формата в C очень распространена в программах. Отсутствие спецификатора формата может вызвать столько проблем, потому что хакер может воспользоваться такими строками и манипулировать выводом.

Учти это:

```python
printf("%x%x%x%x");
```

Здесь нет текста, но есть несколько спецификаторов формата.

При выполнении такой функции учитываются только первый стек и соответствующая ему переменная. Остальные для спецификаторов %x будут обработаны соответствующим образом.

### Веб-приложения

Веб-приложения, содержащие модули языка C, подвержены этой атаке. Вероятность этой атаки в веб-приложениях высока, поскольку большинство веб-серверов основаны на C или C++. Таким образом, уязвимый код может легко попасть в веб-приложение.

Строка формата в коде Javascript тоже может оказаться проблемой.

Кроме того, приложения PHP, использующие sprintf, также могут вызвать проблему уязвимости строки формата sprintf, если хакер опытен. Эта лазейка также использовалась для проведения [атак путем внедрения SQL-кода](https://www.wallarm.com/what/structured-query-language-injection-sqli-part-1) в прошлом.

### Приложения Python

Этой атаке подвержены не только C или C++. Строка формата в Python также очень часто встречается. Фактически, хорошо проработанная техническая статья показала, что Python более подвержен этой уязвимости по сравнению с C или C++. Здесь стоит отметить тот факт, что каждая строка Python поддерживается методом format().

Например, пусть код print("Каталог {} содержит {} файлов".format("Office", 32))

В этом примере каждый заполнитель {} заменяется соседним аргументом метода format(). Но есть вероятность, что format() может принять объект и обработать его атрибуты для завершения заданной строки формата, поскольку это просто. Теперь давайте воспользуемся классом DirData и предположим, что тот же модуль содержит глобальную переменную, хранящую секретное значение.

```python
SECRET_VALUE = "getintosystem"
class DirData:
def __init__(self):
self.name = "Office"
self.noOfFiles = 32
print("Directory {dirInfo.name} contains {dirInfo.noOfFiles} files".
format(dirInfo=DirData()))
```

В этом случае объекты Python теперь могут обращаться к различным внутренним атрибутам. Если мы свяжем эти атрибуты вместе, возможный результат будет таким:

Секрет в том: getintosystem

## Меры по предотвращению атак на строку формата

Для безопасной и надежной разработки программного обеспечения нельзя игнорировать ни одну уязвимость. Вот несколько советов, которым нужно следовать для его ранней и безусловной фиксации:

- Убедитесь, что строка не определена как тип ввода. Его всегда следует определять как часть программы.
- Старайтесь использовать константные строки и делать раннее извлечение переменных частей.
- Format_Guard.Rare — отличный превентивный инструмент, который может исправить все патчи для glibc и защитить от различных ошибок формата. Используйте его на этапе проектирования.
- Содействовать нормальному использованию функции printf. Пока он используется правильно, никакая уязвимость не сможет создать хаос.
- Используйте Kimchi, известное решение для перезаписи двоичных файлов. Он предназначен для предотвращения появления лазейки в строковом формате во время выполнения. Он отслеживает вызовы машинного кода, которые получает printf, и заменяет их самой безопасной из возможных версий printf, то есть safe_printf.
- Создавайте динамические адреса [с помощью ASLR или рандомизации адресного пространства](https://www.wallarm.com/what/what-is-aslr-address-space-layout-randomization) . Полезно создавать динамические адреса для функций, библиотек, переменных и других важных аспектов. Динамические адреса не так просто манипулировать. Следовательно, шансы атак, связанных со строками, низки.
- Никогда не игнорировать предупреждение компилятора — это также отличная техника предотвращения атаки на форматную строку, которую стоит попробовать. В процессе разработки компиляторы уведомляют разработчиков о наличии уязвимых функций. Ответственный разработчик — это тот, кто серьезно отнесется к этому предупреждению и немедленно заменит уязвимую функцию безопасной версией.


## Заключительные примечания

Функциональные строки являются неотъемлемой частью C и многих других ключевых языков программирования, и любая ошибка или уязвимость в них вызовет огромную операционную ошибку в программе. Следовательно, узнайте о возможностях и методах предотвращения, чтобы свести к минимуму ущерб.