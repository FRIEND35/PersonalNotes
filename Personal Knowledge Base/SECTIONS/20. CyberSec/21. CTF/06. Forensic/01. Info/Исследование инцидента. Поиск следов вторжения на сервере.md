Если вы подозреваете, что ваш сервер мог быть взломан и хотите найти на сервере следы взломщика, то эта статья поможет вам провести первичную проверку сервера. Эта инструкция поможет обнаружить злоумышленника, если он не получил root доступа или не смог "замести" следы.

Существуют очевидные признаки взлома: на страницах мелькает куча рекламы, которую вы не размещали, меняется вид страниц, вы не можете зайти в кабинет администратора, гугл и яндекс сообщают о том, что ваш сайт вредоносный, а IP появился в спам-базах.  
  
Но зачастую сразу обнаружить, что сайт взломан, невозможно – ведь явных отклонений от обычной работы нет. Так какие признаки могут указать на то, что ваш сайт взломали?

## Как хакеры взламывают сайты

Обычно хакеры используют ботов для обхода десятков тысяч сайтов с целью найти в них уязвимости по спискам известных уязвимостей, которые находятся в открытом доступе. Когда боты находят такие сайты, они взламывают их по известному алгоритму, отправляют сообщение хакеру и идут дальше.

Иногда хакеры взламывают сайты вручную, когда хотят получить доступ к какому-то определенному сайту, но по сравнению с автоматическим способом это происходит очень редко.

Основные способы, которыми хакеры проникают на сайты:

- **Перебор паролей** (взлом грубой силой) — Хакер просто пытается угадать ваш логин и пароль. Если вы используете простые логины, например, Admin или Administrator, это дает хакерам половину данных для доступа к вашему сайту. Если вы используете простые пароли, то это еще более ускоряет проникновение на ваш сайт.
- **Уязвимости софта** — Когда хакеры определяют, что вы используете устаревший софт, по спискам известных уязвимостей, находящимся в открытом доступе, они находят уязвимость в вашей устаревшей версии Вордпресс, плагина, темы или скрипта, и, например, внедряют свой скрипт для проникновения на ваш сайт.
- **Бэкдоры** — Хакер внедряет файл в файловую структуру сайта. В файле находится скрипт, который позволяет хакеру получить доступ к сайту, оставаясь при этом незамеченным. [Бэкдоры](https://techbear.ru/kak-nayti-i-udalit-backdoor-na-wordpress-sayte/).
- **Небезопасный сервер** — Сервер, на котором расположен ваш сайт, должен быть безопасным. Если он небезопасен, хакеры могут использовать уязвимости в ПО сервера для проникновения на ваш сайт.
- **Неверные права доступа** — [Права доступа](https://techbear.ru/prava-dostupa-k-faylam-i-papkam/) к файлам и папкам определяют, кто может читать, записывать и исполнять файлы. Если вы установите слишком низкие права доступа, хакеры смогут редактировать ваши файлы, внедрять скрипты, например, бэкдоры, и в итоге получат контроль над сайтом.
- **XML-RPC эксплоиты** — XML-RPC используется для подключения стороннего софта к Вордпресс. Например, хакеры могут использовать эту функцию для выполнения удаленных автоматических атак с перебором паролей, когда они без ограничения с высокой частотой перебирают разные варианты логина и пароля. [Подробнее](https://techbear.ru/kak-otklyuchit-xml-rpc/).
- **Вредоносное ПО и вирусы** — Если у вас на компьютере есть вредоносное ПО или вирусы, хакеры могут их использовать для проникновения на сайт.
- **Фишинг** — Хакеры могут захватить или создать похожий на оригинальный сайт. На захваченном или похожем сайте хакеры создают похожую на оригинальную форму авторизации, чтобы похитить персональные данные пользователей, когда они авторизуются на сайте.
- **XSS-атаки** _(Cross-site Scripting)_ — Это код, написанный определенным образом, который позволяет хакеру записывать и выполнять вредоносный JavaScript, который сохраняет данные браузера пользователя. Хакеры отправляют ссылку пользователям сайта, чтобы похитить любую информацию, введенную пользователями при просмотре сайта.
- **CSRF** _(Cross-site request forgery)_ — Подделка межсайтового запроса. Хакер вносит изменение в оригинальный запрос пользователя, создавая свой вредоносный запрос. У хакера нет прав администратора, поэтому он обманным путем заставляет пользователя совершать действия, которые дают хакеру разрешение на выполнение этого вредоносного запроса. Такой тип атак используется для того, чтобы заставить пользователя делать нужные действия, например, ввести свои логин и пароль для входа на сайт.

Это основные типы атак, которые используют хакеры, но кроме этих существуют и другие, поэтому практически невозможно угадать, каким именно путем хакер проник на сайт.

Вы можете попробовать что-то сделать, например, поменять пароли, но если вы видите, что хакер все равно продолжает проникать на сайт, значит, проблема еще не решена.

Единственный способ вылечить сайт — это выяснить, как хакер на него попадает, и устранить эту уязвимость.

# Куда обращать внимание 

  
В первую очередь обратите внимание на изменения в производительности сервера и посещаемости вашего сайта. Если страницы грузятся медленнее, а трафик отличается от того, какой у вас обычно был – время обеспокоиться.

# Журнал событий сервера

Логи веб сервера могут содержать информацию или дать подсказку о том, как сайт был взломан.

Логи находятся на хостинг панели, в зависимости от используемого софта они могут называться по-разному: «Логи», «Журнал событий», «Метрики» или что-нибудь в этом роде. Обычно в этом разделе находятся 2 журнала: «**Логи ошибок**» и «**Логи доступа**». Лог ошибок сервера короче, поэтому начать можно с них, но они не показывают успешные попытки доступа.

Логи доступа содержат информацию об успешных попытках доступа, здесь больше вероятность найти следы взлома.

Записи в журнале хранятся на сервере определенное количество дней, после чего они автоматически удаляются. Скопируйте их на компьютер, пока они не были удалены с сервера.

Сохраните файлы на компьютер из хостинг панели или напрямую с сервера, и откройте в любой текстовой программе, например [Notepad++](https://notepad-plus-plus.org/downloads/) или [Brackets](http://brackets.io/).

### Настраиваем логи

Очень важным пунктом в обнаружении взлома являются логи сервера. Поэтому стоит удостовериться, что журналирование настроено правильно. Тогда, в случае чего, вы будите иметь все необходимые сведения касательно произошедших событий.  
  
Рассмотрим возможную настройку логов. В приведенных ниже примерах в качестве ОС используется Linux, а в качестве сервера – nginx.  
  
Настройка logrotate для nginx не является чем-то особо сложным. Достаточно создать файл /etc/logrotate.d/nginx, содержащий следующий код:  

```
/opt/nginx/logs/*.log {
    daily                   # ротация осуществляется ежедневно
    missingok               # отсутствие файла не является ошибкой
    rotate 30               # хранить 30 дней
    compress                # сжимать файлы в ротации
    delaycompress           # текущий файл в ротации не сжимается 
    notifempty              # не обрабатывать пустые файлы
    create 640 user users   # create <права><владелец><группа>. 
                            # После ротации создает пустой log-файл. 
                            # Если атрибуты не предоставлены, то для нового файла будут использованы атрибуты,  что и у первоначального log-файла           
    postrotate              # Перезапуск nginx
            [ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
  ```

По возможности, лучше добавить автоматическое копирование логов в корпоративное облако или на другой сервер, дабы злоумышленник, если он решит почистить логи, не лишил бы вас их навсегда.  
 
## Смотрим внутрь

Итак, логи у вас есть. Теперь стоить проверить серверные access логи на подозрительную активность. Приходило множество запросов с одного и того же IP? Множество запросов с разных IP, но сами запросы и интервалы между ними похожи? Все это еще один дополнительный повод проверить, не перехватил ли уже кто-нибудь доступ к сайту.  
  
Подобную проверку можно организовать через парсинг access логов с помощью awk. Вот несколько команд для awk, которые помогут проанализировать access логи для nginx:  
  
• IP-адреса, отсортированные по количеству запросов:  
  

```
awk '{print $1}' access.log | sort | uniq -c | sort -rn  
```
  
• 10 последних уникальных запросов, отсортированных по количеству:  
  

```
awk '{print $7}' access.log | sort | uniq -c | sort -rn | tail -n 10
```

  
• Уникальные IP-адреса, отсортированные по количеству запросов к странице /administrator/ (сюда можно подставить любую вас интересующую — например, одну из тех, что вы получили с помощью предыдущей команды):  
  
```
awk '($7 ~ /administrator/)' access.log | awk '{print $1}' | sort | uniq -c | sort -rn
```  
  
• IP-адреса и страницы, к которым запрашивали доступ, отсортированные по количеству попыток  
  
```
awk '{print $1, $7}' access.log | sort | uniq -c | sort –r
```  
  
• Для мониторинга аномальной активности может помочь и отслеживание подозрительных юзерагентов. Например, написано просто «Google», указана очень старая версия «Internet Explorer», или браузером числится краткое «Mozilla», вместо полной строки с указанием версии и платфомы. Команда ниже выведет все уникальные юзерагенты, отсортированные по количеству обращений с их использованием:  
  
```
awk -F'"' '{print $6}' access.log | sort | uniq -c | sort -rn
```

# Идем по «следам»

Также если вы заметили, что логи резко выросли в объеме или в access логе много раз обращаются к страницам, которых у вас не было – еще один повод насторожиться. Подобное изменение трафика может являться следствием различных причин. Одна из них может быть связана с тем, что ваш сайт стал медленнее грузиться (о чем речь пойдет позже), однако не все случаи столь тривиальны. Сегодня существует вредоносное ПО, которое будет просто перенаправлять пользователей на сайты, нужные злоумышленнику, причем оно может не влиять на авторизованных пользователей, что поможет дольше скрывать факт взлома.  
  
Обычно встречающиеся вредоносы часто оставляют за собой и другие «следы». В панели администратора возникают новые пользователи, которых туда никто не добавлял (чаще всего со странными именами), на сервере появляются скрипты и файлы, взявшиеся непонятно откуда, а почтовый ящик может содержать подозрительные письма. Также стоит проверить, нет ли в запланированных задачах новых и неизвестных для вас.  
  

## «Присматриваем» за своим имуществом

А чтобы легко отслеживать, не изменял ли кто-либо ваши файлы, стоит добавить в cron простой скрипт, который будет это проверять:  
  

```
#!/bin/bash

find ./ -iname '*.php' -cmin -1 > ./files.txt 
[ -s ./files.txt ] && echo "Subject: static files changed!" | sendmail -v user@mail.com < ./files.txt
```

  
./ — текущая папка (необходимо указать нужную)  
'*.php' — любой файл с расширением .php (если у вас скрипты на Python, то ставим расширение .py и так далее)  
-1 — указание временного промежутка. Его стоит устанавливать в зависимости от того, как часто вы хотите проверять, не пытался ли кто-нибудь изменить ваш код. В данном примере выставлена одна минута.  
  
Если какие-то файлы были изменены, то имена этих файлов запишутся в файл files.txt и отправятся на почту. Вместо утилиты sendmail можете использовать любую, которая вам больше нравится (например, Postfix).  
  

## Контролируем «прожорливость»

Если вы заметили, что сайт стал грузиться медленнее, хотя вы ничего не добавляли, это тоже повод проверить, на что же идут ресурсы. Сильно поможет, конечно, если у вас есть история/логи, касающиеся производительности. Таким образом можно будет посмотреть, не было ли внезапного роста нагрузки на сайт, хотя никаких обновлений и новых элементов вы не добавляли. Если производительность выше, чем вы ожидаете, то стоит задуматься, не взломали ли вас.  
  
Для отслеживания производительности очень удобно использовать утилиту sysstat.  
  
Настройка постоянного логирования осуществляется добавлением в файл /etc/cron.d/sysstat следующих строк:  
  

```
*/15 * * * * root /usr/lib/sysstat/sa1 1 1
55 23 * * * root /usr/local/lib/sa/sa2 -A
```

  
Первая строка обозначает, что раз в 15 минут будут собираться данные системы. Храниться они будут в /var/log/sysstat/saDD, где DD — текущая дата. Вторая строка, что в 23:55 будет создан полный отчет за прошедший день. Лежать он будет в /var/log/sysstat/sarDD  
Посмотреть данные для CPU можно следующей командой:  
  

```
sar -P ALL -f /var/log/sysstat/saDD
```

  
Данные по использованию памяти:  
  

```
sar -r -f /var/log/sysstat/saDD
```

  
Полный список ключей для вывода можно найти [на официальном сайте](http://sebastien.godard.pagesperso-orange.fr/man_sar.html).  
  
## А я на вас ссылался?
  
Стоит ещё проверить все исходящие ссылки с вашего сайта (например, с помощью [данного сервиса](http://www.seoreviewtools.com/internal-link-analyzer/) или других подобных) – не появилось ли новых? Тех, что вы не добавляли? Вдобавок хорошо бы проверить, что отображается в поисковиках касательно вашего сайта и по каким фразам к вам попадают посетители. Посмотрите на всякий случай, как работает ваш сайт для разных платформ/стран/браузеров – вредоносы могут срабатывать только для какой-нибудь определенной категории пользователей, это делается с целью оставаться незамеченными.  
  
Необходимо проверять указанные выше признаки и места по меньшей мере раз в неделю, дабы сильно не выпускать из рук ситуацию, если сайт все же был взломан. Отслеживание новых обновлений для используемого ПО и важных обновлений безопасности, наряду с планированием бэкапов и периодической сменой паролей, вообще должны быть частью стандартных периодических процедур.

# Пользователи 

Итак, первым делом меняем рутовый пароль:  
  
```
[root@myhost etc]# passwd
Changing password for user root.
New UNIX password:
...
```

Смотрим список пользователей сервера

```
cat /etc/passwd
```

Убеждаемся, что только один пользователь имеет идентификатор пользователя UID (третье значение в каждой строке) равный 0. В нём не должно быть пользователей с uid=0, кроме root

Смотрим файл паролей пользователей сервера

```
cat /etc/shadow
```

Убеждаемся, что вход по паролю доступен только нужным пользователям (второе значение не является символом «звездочка»). Изменяем пароли для всех таких пользователей.

```
sudo passwd root
```

Пароли должны быть длинными и сложными.

Проверяем историю входа пользователей ОС (показать последние 20 входов)

```
last -20
```

Смотрим, кто, когда и с какого IP заходил и пытаемся понять, есть ли взломщик. Вход одного пользователя с разных IP может быть признаком взлома.

Чтобы посмотреть все входы конкретного пользователя, нужно выполнить (user нужно заменить на имя пользователя)

```
last user
```

Для каждого пользователя смотрим файл ~/.ssh/authorized_keys и убеждаемся, что в них нет чужих ключей.

Для каждого пользователя смотрим историю команд и ищем что-то подозрительное (перейти в конец истории: Shift + G)

```
history | less
```

# MySQL

Подсоединяемся к MySQL и убеждаемся, что внешнее соединение с базами данных отсутствует (если вам не требуется внешнее соединение).

```
$ mysql -u root -p
mysql> SELECT user, host FROM mysql.user;
```

Точнее посмотреть привилегии пользователя можно так

```
SHOW GRANTS FOR 'user'@'localhost';
```

Если необходимо для каждого mysql-пользователя меняем пароль

```
SET PASSWORD FOR 'user'@'localhost' = PASSWORD('newpass');
```

# Запущенные процессы


# Открытые порты

Далее сканируем хост на предмет подозрительных открытых портов. Сделать это можно, например, с другой юниксовой машины с помощью утилиты nmap:

```
nmap xxx.xxx.xxx.xxx
```

В результате получаем, например, так

```
Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-19 22:05 +06
Nmap scan report for site.ru (000.000.000.000)
Host is up (0.087s latency).
Not shown: 997 filtered ports
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https
```

Убеждаемся, что не открыто «лишних» портов, через которые можно повторно взломать сервер. Под «лишними» понимаются открытые порты, которые не нужны для целей сервера. filtered означает, что nmap не может определить, является ли порт открытым или закрытым.

Открытые порты можно посмотреть и на самом проверяемом сервере, выполнив (ss улучшенный аналог netstat)

```
sudo ss -tulpn
```

Смотрим открытые для внешнего обращения порты.

# Проверка ssh-ключа

Следующим пунктом нужно проверить фолдер /root/.ssh, туда могли положить ключ для ssh-клиента каким-либо образом.  

```  
[root@myhost ~]# dir /root/.ssh
authorized_keys_
```
  
Здесь оказался только файл с ключами, который я переименовал сразу после передачи хоста провайдером.

# Изменённые системные файлы

Ищем файлы в системных каталогах, содержимое или атрибуты которых изменялись за последние дни. Например, ищем в каталоге /etc за последние 10 дней и показываем подробную информацию колонками

```
sudo find /etc -type f -ctime -10 -exec ls -ltc '{}' + | column -t | less
```
``
Можно искать файлы в диапазоне дат (от и до). Например, ищем файлы, измененные не раньше 10 дней, но не позднее 7 дней, результат записываем в файл changed.txt

```
find /etc -type f -ctime +7 -ctime -10 -exec ls -ltc '{}' + > changed.txt
```

Подробнее об атрибутах файла можно посмотреть командой stat

```
stat /etc/nginx/nginx.conf
```

Дополнительно смотрите [Структура каталогов в системе Linux](https://dibit.ru/p/profs/linux/file-stru%D1%81ture)

# rkhunter 

И тут тоже было всё окей. Финальным аккордом являлась проверка хоста на установленные руткиты. Для этого можно использовать бесплатную утилиту [rkhunter](http://rkhunter.sourceforge.net/). Скачиваем архив с последней версией, распаковываем его и запускаем инсталлер. Далее делаем его обновление и запускаем проверку:  
  
```
[root@myhost ~]# ./installer.sh --install --layout /usr/local
[root@myhost ~]# /usr/local/bin/rkhunter –-update
[root@myhost ~]# /usr/local/bin/rkhunter –-check
```


  
Rkhunter в начале проверят важные системные файлы, затем ищет руткиты. После происходит проверка на различные vulnerabilities. В конце программа проверяет версии популярных продуктов, таких как Apache, OpenSSH и т.п. на предмет последних версий.  
  
Результаты своей работы rkhunter выдает в консоль, а также формирует консолидированный лог /var/log/rkhunter.log. Можно запускать данный антируткит каждый день по крону и получать отчет о сканировании по электронной почте.  
  
К счастью, rkhunter не обнаружил на моём сервере никаких зловредов, это позволило успокоиться и подумать, что же за странные инсталлы произошли на сервере. И тут я вспомнил, что сразу после получения сервера, я установил и сконфигурировал на этом сервере VPN сервер. Видимо, произошла какая-то ошибка в Logwatch и он добавил в отчёт данные двухлетней давности.  
  
Разумеется, если злоумышленники всё сделают грамотно, то Logwatch никаких следов не обнаружит и хозяин сервера долго ни о чём не будет подозревать. Однако, шаги, описанные в данном HowTo, если проводить их регулярно, помогут уберечь ваши сервера от компроментации.
# Что дальше?

Если следов взлома найдено не было, но уверенность в этом сохраняется, то необходимо проверить целостность системных пакетов и скриптов, а также установить, настроить и постоянно использовать logwatch или аналог.

Несмотря на свою значимость, в этой статье не был рассмотрен поиск следов взлома интернет-сайта. Нужно помнить, что взлом сервера может быть осуществлен через бреши в безопасности сайта, но это отдельная тема.