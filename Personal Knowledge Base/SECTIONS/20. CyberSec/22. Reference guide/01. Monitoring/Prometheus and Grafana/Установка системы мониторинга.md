
Источники:

https://help.reg.ru/support/servery-vps/oblachnyye-servery/ustanovka-programmnogo-obespecheniya/sistema-monitoringa-prometheus
https://losst.pro/ustanovka-i-nastrojka-prometheus
https://serverspace.ru/support/help/install-prometheus-ubuntu-20-04/
https://laurvas.ru/prometheus-p1/
https://blogs.sap.com/2023/04/16/how-to-bring-data-from-local-node_exporter-to-prometheus-and-then-to-the-grafana-cloud/
https://habr.com/ru/articles/709204/
https://habr.com/ru/articles/652185/
https://1cloud.ru/blog/grafana_prometheus_system
https://it-dev-journal.ru/articles/monitoring-linux-servera-s-prometheus-node-exporter
# Введение 

[[Мониторинг | Метрики]]  — это абстракция, с которой мы имеем дело, когда говорим о мониторинге. Это какие-то числа, описывающие состояние интересующей нас штуковины. Самый простой и понятный мониторинг следит за ресурсами компьютера: загрузкой процессора, памяти, диска, сети. Аналогично можно следить за чем-то более высокоуровневым, вроде количества посетителей на сайте или среднего времени ответа сервера. Для компьютера это один хрен безликие числа.

[[Мониторинг]]  — это инструмент анализа того, что происходит/происходило в системе. Следовательно, без понимания смысла собранных данных мониторинг вам не особо поможет. И наоборот: в умелых руках это мощный инструмент. Чем больше компонентов в вашей системе (микросервисов), чем больше нагрузка на неё, чем дороже время простоя, тем важнее иметь хорошую систему мониторинга.

То, что не метрики — то логи. Их тоже надо собирать и анализировать, но это отдельная история со своими инструментами. Сейчас модно делать мониторинг на основе Prometheus. Так ли он хорош на самом деле? На мой взгляд это лучшее, что сейчас есть из мониторинга. Оговорюсь сразу для тех, кто хочет с этим поспорить: я понимаю, что разным задачам — разные инструменты и где-то больше подходит старый проверенный Nagios. Но в целом лидирует Prometheus.

Prometheus — это не готовое решение в духе “поставил и работает” (привет, Netdata). Это платформа, набор инструментов, позволяющий сделать себе такой мониторинг, какой надо. Фреймворк, если хотите.

Основные преимущества — предоставление возможности создания гибких запросов к данным и хранение значений метрик в базе данных временных рядов, возможность автоматизации при администрировании. Разработана фондом облачных вычислений (Cloud Native Computing Foundation или CNCF).

Для получения метрик с удаленных узлов используется метод pull (сервер сам забирает данные). На узлы для сбора информации устанавливаются экспортеры (exporter) — пакеты, получающие данные для операционной системы или конкретного сервиса. Существует большое количество уже написанных экспортеров для различных приложений. Также метрики могут собираться с помощью механизма push — для этого используется компонент pushgateway, который должен быть установлен дополнительно.
### История и определение

На заре появления компьютерных сетей в конце 1970х – начале 1980х гг. главной задачей мониторинга была проверка связности и доступности серверов. В 1981 году появился протокол [ICMP](https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol), на основе которого в декабре 1983 года написана утилита [ping](https://en.wikipedia.org/wiki/Ping_(networking_utility)), а позднее и [traceroute](https://en.wikipedia.org/wiki/Traceroute), которые используются для диагностики сетевых неполадок и по сей день. Следующим этапом стало создание в 1988 году протокола [SNMP](https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol), что привело к рождению [MRTG](https://en.wikipedia.org/wiki/Multi_Router_Traffic_Grapher) – одной из первых программ для мониторинга и измерения нагрузки трафика на сетевые каналы. Параллельно с середины 1980х гг. стало активно разрабатываться программное обеспечение для мониторинга потребления ресурсов компьютерами, такое как [top](https://en.wikipedia.org/wiki/Top_(software)), [vmstat](https://en.wikipedia.org/wiki/Vmstat), [nmon](https://en.wikipedia.org/wiki/Nmon), [Task Manager](https://en.wikipedia.org/wiki/Task_Manager_(Windows)) и др. К середине 1990х годов в связи с ростом ИТ инфраструктуры многие компании стали испытывать потребность в комплексной и централизованной системе мониторинга, что послужило спусковым крючком для синхронного начала разработки нескольких прототипов. В 1999-2002 гг. на свет появились решения, предопределившие развитие отрасли на годы вперед и развивающиеся до сих пор – [Cacti](https://en.wikipedia.org/wiki/Cacti_(software)), [Nagios](https://en.wikipedia.org/wiki/Nagios) и [Zabbix](https://en.wikipedia.org/wiki/Zabbix).

Мониторинг в ИТ сегодня – это система, которая позволяет в режиме реального времени выявлять проблемы в ИТ инфраструктуре, а также оценивать тренды использования ресурсов. Как правило состоит из нескольких базовых компонентов – сбора сырых данных, обработки данных с целью их анализа, рассылки уведомлений и пользовательского интерфейса для просмотра графиков и отчетов. В настоящее время существует большое количество систем для мониторинга различных категорий – сети, серверной инфраструктуры, производительности приложений (APM), реального пользователя (RUM), безопасности и др. Таким образом, мониторить можно все – от сетевой доступности узлов в огромной корпорации до значений датчика температуры в спальне в «умном» доме.


# Prometheus

**Prometheus** — система мониторинга серверов и программ с открытым исходным кодом. Она была выпущена в 2012 году для мониторинга музыкальной социальной сети SoundCloud. Из-за специфики архитектуры SoundCloud традиционные системы мониторинга не подходили, поэтому по новой технологии был создан Prometheus-мониторинг. Позже новый мониторинг сервисов стал интересен за пределами музыкальной сети. Создатели доработали систему и предложили её более широкому рынку. Релиз обновлённой программы прошёл в 2015 году.

Система мониторинга Prometheus может собирать информацию о состоянии серверов и систем (Linux-сервера, Apache-сервера, сервера баз данных), а также получать предупреждения о проблемах. Объекты мониторинга называются **целевыми объектами**.

Главное отличие Prometheus от остальных систем мониторинга — метод сбора данных. Обычно объекты мониторинга отправляют нужные параметры серверам мониторинговых программ. Прометеус же наоборот — сам берёт нужную ему информацию с серверов и устройств, обращаясь к целевым объектам при помощи языка **PromQL**. Сервер Prometheus **считывает** параметры целевых объектов с интервалами, которые задаёт пользователь. Данные от целевых объектов передаются на сервер в формате **http** и хранятся в **базе данных временных рядов**. В отличие от системы [Zabbix](https://help.reg.ru/support/servery-vps/oblachnyye-servery/ustanovka-programmnogo-obespecheniya/zabbix-chto-takoye-i-kak-ispolzovat), которая написана на языке С и PHP, Prometheus написан на **Go** и **Ruby**. Prometheus функционирует благодаря таким компонентам, как:

1. **Prometheus-server** — главное звено всей системы. Он отвечает за сбор и хранение данных. Есть простой веб-интерфейс, но для полноценной работы с системой лучше устанавливать дополнительный.
2. **Exporters** — это часть ПО, которая собирает и передаёт Prometheus-метрики серверу. Существуют разные экспортёры, например HAProxy, StatsD, Graphite. Они устанавливаются на целевые объекты и собирают определённые метрики. Если ни один экспортёр вам не подходит, то можно написать свой.

C помощью руководства ниже вы сможете установить Prometheus на CentOS, Debian, Ubuntu. Также мы расскажем, как установить exporter и Alertmanager, чтобы можно было получать сообщения о неисправностях.

## Архитектура Prometheus

Prometheus состоит из отдельных компонентов, которые общаются друг с другом по http. Всё модно-молодёжно, с веб-интерфейсами и настраивается в yaml-конфигах.

![[Pasted image 20240106215549.png]]


В некотором смысле Prometheus можно рассматривать как просто сервер, где находятся метрики. Он собирает метрики с целевых объектов, таких как веб-серверы, базы данных, приложения и т. д., и хранит их в базе данных. Затем пользователи могут использовать Prometheus для получения доступа к этим метрикам и их анализа.

Однако Prometheus также предоставляет ряд дополнительных функций, которые делают его более чем просто сервером для хранения метрик. Например, Prometheus:

- Использует pull-модель сбора метрик, что означает, что он сам инициирует сбор метрик с целевых объектов. Это обеспечивает более высокую надежность сбора метрик, чем push-модель, при которой целевые объекты сами отправляют свои метрики на сервер мониторинга.
- Поддерживает различные типы метрик, включая счетчики, измерители, гистограммы и сводки.
- Предоставляет язык запросов PromQL для анализа метрик.
- Может использоваться для построения графиков и диаграмм метрик.

Таким образом, Prometheus - это более чем просто сервер для хранения метрик. Это полнофункциональная система мониторинга, которая может использоваться для сбора, хранения, анализа и визуализации метрик.

![[Pasted image 20240108165143.png]]


![[Pasted image 20240108165306.png]]

Вот некоторые конкретные примеры того, как Prometheus может использоваться:

- Для мониторинга производительности веб-серверов и приложений.
- Для мониторинга состояния баз данных.
- Для мониторинга систем безопасности.
- Для мониторинга инфраструктуры.

Prometheus является популярной системой мониторинга, которая используется в различных отраслях промышленности, включая IT, финансы, производство и здравоохранение.

![[Pasted image 20231220234225.png]]

  
Prometheus собирает метрики с целевых объектов, которые называются **экспортерами**. Экспортеры - это небольшие приложения, которые собирают метрики из различных источников, таких как операционная система, приложения, базы данных и т. д.

Prometheus может собирать метрики из следующих источников:

- **Метрики операционной системы:** Prometheus может собирать метрики операционной системы, такие как использование процессора, памяти, диска и сети. Для этого он использует экспортер **Node Exporter**, который доступен для всех основных операционных систем.
- **Метрики приложений:** Prometheus может собирать метрики приложений, такие как количество запросов в секунду, время отклика и ошибки. Для этого он использует экспортер **Prometheus Exporter**, который доступен для многих популярных приложений.
- **Метрики баз данных:** Prometheus может собирать метрики баз данных, такие как использование памяти, количество соединений и запросов. Для этого он использует экспортеры, которые доступны для различных баз данных, таких как MySQL, PostgreSQL и MongoDB.
- **Метрики других источников:** Prometheus может собирать метрики из любых других источников, которые предоставляют метрики в формате Prometheus.

Чтобы добавить новый источник метрик в Prometheus, необходимо установить соответствующий экспортер и настроить его для сбора метрик. Затем можно добавить этот экспортер в конфигурацию Prometheus.

Вот несколько примеров того, как Prometheus может собирать метрики:

- Prometheus может собирать метрики использования процессора с каждого сервера в сети.
- Prometheus может собирать метрики производительности веб-приложения с каждого сервера, на котором оно работает.
- Prometheus может собирать метрики состояния базы данных с каждой базы данных в организации.

Prometheus - это гибкая система мониторинга, которая может использоваться для сбора метрик из различных источников.

Выходить что Prometheus это просто хранилище где сохраняются метрики, а сами метрики он собирает из дургих источников - таких как  экспортер. Потом чтобы визуализировать данные которые находяться в Prometheus для удобство мы используем другие программы - такие как Grafana.




- Prometheus server — центральное звено. Здесь хранятся собранные метрики, плюс имеется простенький веб-интерфейс, чтобы на них смотреть (Prometheus web UI).
- Агенты, собирающие метрики и предоставляющие их в понятном для Prometheus’а виде. В зависимости от контекста называются экспортерами (exporter) или таргетами (target). Устанавливаются на целевые машины. Типичный представитель — node_exporter — собирает данные о вычислительных ресурсах: загрузку процессора, памяти, диска и т.п. Есть куча других экспортеров. Например, cadvisor собирает данные о контейнерах. Есть экспортеры для Postgres’а, для Nginx’а и т.д. С точки зрения самого Prometheus’а они ничем принципиально не отличаются друг от друга, просто каждый собирает какие-то свои метрики. Можно писать свои экспортеры, если ничего из готового вам не подходит.
- Alertmanager — уведомлятор. Это он отправит письмо вам на почту, если что-то сломается. Из коробки умеет в почту, Slack, Hipchat, Pagerduty. Сторонними средствами можно прикрутить Telegram и наверное что-то ещё.

Например, метрика может измерять нагрузку на процессор, использование памяти или количество ошибок.

Prometheus работает следующим образом:

- Он периодически запрашивает метрики с целевых объектов, таких как серверы, базы данных или веб-приложения.
- Метрики сохраняются в базе данных Prometheus.
- Данные из базы данных Prometheus можно использовать для анализа и визуализации состояния систем.

Prometheus имеет ряд преимуществ перед другими системами мониторинга:

- Он бесплатный и открытый исходный код.
- Он масштабируемый и может использоваться для мониторинга больших систем.
- Он имеет гибкую модель данных, которая позволяет собирать широкий спектр метрик.

Вот несколько примеров того, как Prometheus может использоваться для мониторинга:

- Мониторинг производительности серверов. Prometheus может использоваться для измерения нагрузки на процессор, использования памяти и других показателей производительности серверов.
- Мониторинг приложений. Prometheus может использоваться для измерения количества ошибок, времени отклика и других показателей производительности приложений.
- Мониторинг инфраструктуры. Prometheus может использоваться для мониторинга таких компонентов инфраструктуры, как сети, хранилища и базы данных.

Prometheus является мощным инструментом, который может использоваться для мониторинга широкого спектра систем и приложений. В сравнении с другими системами мониторинга обладает рядом отличий, например, в сравнении с [Zabbix](https://www.dmosk.ru/terminus.php?object=zabbix):

- Zabbix является полностью законченной системой, которая предоставляет веб-инструмент для настройки и визуализации (dashboard). Prometheus — это всего лишь база данных со значениями для метрик. Для настройки и визуализации используются средства, которые являются сторонними или разработанными самостоятельно.
- Установка Prometheus не может быть выполнена из репозитория простыми командами. Нам необходимо скачать бинарник, а также создать скрипт для автозапуска или юнит в systemd. Также возможно установка из неофициального образа [Docker](https://www.dmosk.ru/terminus.php?object=docker).
- Для отправки уведомлений Zabbix использует штатные средства. Для Prometheus устанавливается и настраивается Alertmanager.
- Zabbix наполнен дополнительными инструментами, такими как графики, построение логической сети, автообнаружение и так далее. Prometheus этим не богат и для дополнительных возможностей необходима установка плагинов или доработка собственных модулей.

Это не все отличия между Zabbix и Prometheus, но уже можно сделать вывод, что последний является приложением от программистов для программистов. Prometheus более популярен для мониторинга сервисов в среде DevOps, например, Kubernetes. Zabbix же плохо подходит для динамических систем (например, в последнем могут постоянно удаляться и создаваться новые поды с сервисами) и уступает в этом плане прометею.
## Установка 

Вы можете установить Prometheus из официальных репозиториев в Ubuntu. Вы можете посмотреть какие пакеты prometheus доступны можно такой командой:

```
sudo apt search prometheus
```

Для установки выполните команду:

```
sudo apt install prometheus
```

Однако в репозиториях содержится уже старая версия программы. Если вы хотите самую свежую версию, то придется скачать её из официального сайта. Поскольку программа написана на Golang, то и распространяется она в виде одного исполняемого файла. Поэтому установить её не сложно, достаточно скачать архив, распаковать и скопировать исполняемый файл в папку **/usr/local/bin**, также надо будет скопировать несколько исполняемых файлов.

Сначала скачайте пакет Prometheus с [официальной страницы GitHub](https://github.com/prometheus/prometheus/releases/). Для Linux нужен пакет с исполняемыми файлами linux-amd64

Все компоненты Prometheus’а написаны на Go и представляют собой статически скомпиленные бинари, не требующие никаких зависимостей кроме libc и готовые запускаться на любой платформе, будь то Debian, Arch или Centos. Установить их можно аж тремя способами:

- по-старинке через пакетный менеджер,
- взять готовые бинари с оф. сайта и засунуть их в систему в обход пакетного менеджера,
- развернуть всё в докер-контейнерах.

Разумеется, у каждого способа есть свои преимущества и недостатки.

**Если ставить через пакетный менеджер,** то через него же вы будете получать обновления и сможете всё удалить. Однако есть нюанс. У Prometheus’а нет своих собственных репозиториев для популярных дистрибутивов, а официальные репозитории Debian/Ubuntu как всегда отстают от апстрима. Например, [сейчас](https://tracker.debian.org/pkg/prometheus) в Debian доступна версия 2.7.1, когда Prometheus [уже](https://github.com/prometheus/prometheus/releases) 2.11.1. Arch Linux — [молодец](https://www.archlinux.org/packages/extra/x86_64/prometheus/), идёт в ногу со временем.

**Если ставить Prometheus в докере,** то всё про мониторинг будет лежать в одном месте. Можно это хозяйство положить под Git и иметь возможность поднять мониторинг в две команды: `git clone`, `docker-compose up`. Но надо писать правильный `docker-compose.yml`, париться при возникновении сетевых проблем… Короче, вы от одних проблем избавляетесь, а взамен получаете другие. В зависимости от того, с какими вам больше нравится возиться, выбирайте тот или иной вариант установки. Вам понадобятся контейнеры `prom/prometheus`, `prom/node_exporter`, `prom/alertmanager`. За основу рекомендую взять `docker-compose.yml` из [репозитория docprom](https://github.com/stefanprodan/dockprom).

В продакшене я бы поднимал мониторинг в докере как минимум в целях безопасности. Свой личный мониторинг я устанавливал по-старинке вручную.

## Установка вручную

### Установка Prometheus server

Идём на [https://github.com/prometheus/prometheus/releases](https://github.com/prometheus/prometheus/releases), находим билд под свою платформу (скорее всего это будет linux-amd64). Копипастим ссылку, качаем:

```
$ wget https://github.com/.../prometheus-2.11.1.linux-amd64.tar.gz
$ tar xf prometheus-*.tar.gz
```

Раскидываем файлы по ФС, заводим пользователя. Нам нужно:

- Для конфигурационных файлов необходимо создать папку /etc/prometheus
- Затем скопируйте туда такие папки с конфигурационными файлами
- Для запуска программы понадобится пользователь prometheus

```
# cd prometheus-*
# cp prometheus promtool /usr/local/bin
# mkdir /etc/prometheus /var/lib/prometheus
# cp -r consoles/ /etc/prometheus/consoles/
# cp -r console_libraries/ /etc/prometheus/console_libraries/
# cp prometheus.yml /etc/prometheus
# useradd --no-create-home --home-dir / --shell /bin/false prometheus
```

Или же:

```
sudo useradd --no-create-home --shell /bin/false prometheus
```

```
mkdir /var/lib/prometheus                           #Создайте папку для хранения данных
chown -R prometheus:prometheus /var/lib/prometheus  #Создайте пользователя и назначьте владельца файлов и папок
```

Или же:

```
chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus
```

В архиве будут два ненужных каталога: `console_libraries/` и `consoles/`. Их не трогаем.

В них содержатся файлы для работы веб-интерфейса программы. Кроме того, нужно создать конфигурационный файл /etc/prometheus/prometheus.yml со следующим содержимым:

```
sudo vi /etc/prometheus/prometheus.yml
```

```
global:
  scrape_interval: 15s
scrape_configs:
  - job_name: 'prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:9090']

```

Здесь сказано, что по умолчанию интервал сбора данных составляет 15 секунд, а также добавлена задача по сборку данных с самого Prometheus. Никаких данных о состоянии сервера там не будет, только параметры работы программы.

Создаём systemd-юнит:

```
/etc/systemd/system/prometheus.service
```

```text
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Restart=on-failure
ExecStart=/usr/local/bin/prometheus \
  --config.file /etc/prometheus/prometheus.yml \
  --storage.tsdb.path /var/lib/prometheus/
ExecReload=/bin/kill -HUP $MAINPID
ProtectHome=true
ProtectSystem=full

[Install]
WantedBy=default.target
```

Или же:

```
sudo systemctl edit --full --force prometheus.service
```

```
[Unit]  
Description=Prometheus  
Wants=network-online.target  
After=network-online.target  
[Service]  
User=prometheus  
Group=prometheus  
Type=simple  
ExecStart=/usr/local/bin/prometheus \  
--config.file /etc/prometheus/prometheus.yml \  
--storage.tsdb.path /var/lib/prometheus/ \  
--web.console.templates=/etc/prometheus/consoles \  
--web.console.libraries=/etc/prometheus/console_libraries  
[Install]  
WantedBy=multi-user.target
```

Или же:

```
vim /etc/systemd/system/prometheus.service
```

Впишите в файл конфигурацию сервиса Prometheus:

```
[Unit]

Description=Prometheus systemd service unit

Wants=network-online.target
After=network-online.target
```

```
[Service]

Type=simple

User=prometheus

Group=prometheus
ExecReload=/bin/kill -HUP $MAINPID
ExecStart=/usr/local/bin/prometheus \
--config.file=/etc/prometheus/prometheus.yml \
--storage.tsdb.path=/var/lib/prometheus \
--web.console.templates=/etc/prometheus/consoles \
--web.console.libraries=/etc/prometheus/console_libraries \
--web.listen-address=0.0.0.0:9090

SyslogIdentifier=prometheus
Restart=always
```

```
[Install]

WantedBy=multi-user.target
```

Запускаем Prometheus server:

```
# systemctl daemon-reload
# systemctl start prometheus
# systemctl status prometheus
```

В статусе должно быть написано “active (running)” — значит работает. Теперь можно сходить на [http://localhost:9090](http://localhost:9090/) и полюбоваться на интерфейс Prometheus’а. Пока что он бесполезен, но уже можно потыкать.

Готово, теперь Prometheus доступен по адресу **$IP:9090**

### Установка node exporter

Чтобы Prometheus мог собирать данные с целевых объектов, установите node_exporter. Данные в Prometheus поступают из так называемых экспортёров, программ, которые делают различные метрики доступными по HTTP адресу /metrics. Сервер Prometheus регулярно опрашивает такие экспортёры и собирает с них данные. Экспортеры существуют для различных служб и сервисов, например, для Nginx, MySQL, PHP-FPM, Apache ну и естественно экспортёр общих сведений о сервере. Такой экспортёр называется Node_exporter. Он тоже написан на Golang как и большинство экспортёров для Prometheus.

Node Exporter - это инструмент, который предоставляет Prometheus метрики о состоянии сервера. Он собирает данные о таких показателях, как нагрузка на процессор, использование памяти, использование диска и сетевая активность.

Node Exporter работает следующим образом:

- Он запускается на сервере, который необходимо мониторить.
- Он собирает данные о состоянии сервера.
- Он отправляет данные Prometheus.

Node Exporter является простым и эффективным способом сбора метрик о состоянии сервера. Он может использоваться для мониторинга широкого спектра серверов, включая физические серверы, виртуальные машины и контейнеры.

Вот некоторые из метрик, которые собирает Node Exporter:

- Загрузка на процессор
- Использование памяти
- Использование диска
- Активность сети
- Температура процессора
- Напряжение питания
- Количество ошибок

Node Exporter может использоваться в сочетании с другими инструментами Prometheus, такими как Grafana, для создания панелей мониторинга, которые отображают данные о состоянии сервера.

Вот несколько примеров того, как Node Exporter может использоваться:

- Мониторинг производительности сервера. Node Exporter может использоваться для отслеживания изменений производительности сервера и выявления потенциальных проблем.
- Мониторинг состояния сервера. Node Exporter может использоваться для отслеживания таких показателей, как температура процессора и напряжение питания, чтобы обеспечить безопасность сервера.
- Мониторинг использования ресурсов. Node Exporter может использоваться для отслеживания использования ресурсов сервера, чтобы обеспечить эффективное использование ресурсов.

В целом, Node Exporter является мощным инструментом, который может использоваться для мониторинга широкого спектра серверов.

Вот некоторые из преимуществ использования Node Exporter:

- Простота установки и настройки. Node Exporter может быть установлен и настроен за считанные минуты.
- Широкий спектр поддерживаемых метрик. Node Exporter собирает данные о широком спектре показателей состояния сервера.
- Совместимость с Prometheus. Node Exporter совместим с Prometheus, что позволяет легко собирать и визуализировать данные о состоянии сервера.

Node Exporter является важным инструментом для мониторинга серверов. Он может использоваться для отслеживания производительности, состояния и использования ресурсов серверов.

Node exporter надо раскатать на всех машинах, которые вы хотите мониторить. Устанавливается он аналогично серверу. Берём последний билд с [https://github.com/prometheus/node_exporter/releases](https://github.com/prometheus/node_exporter/releases).

```
$ wget https://github.com/.../node_exporter-0.18.1.linux-amd64.tar.gz
$ tar xf node_exporter-*.tar.gz
# cd node_exporter-*
# cp node_exporter /usr/local/bin
# useradd --no-create-home --home-dir / --shell /bin/false node_exporter
```

```
/etc/systemd/system/node_exporter.service
```

```text
[Unit]
Description=Prometheus Node Exporter
After=network.target

[Service]
Type=simple
User=node_exporter
Group=node_exporter
ExecStart=/usr/local/bin/node_exporter

SyslogIdentifier=node_exporter
Restart=always

PrivateTmp=yes
ProtectHome=yes
NoNewPrivileges=yes

ProtectSystem=strict
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=yes

[Install]
WantedBy=multi-user.target
```

**Важно!** Если у вас `/home` вынесен на отдельный раздел, директиву `ProtectHome=yes` надо убрать, иначе node exporter будет неправильно показывать оставшееся место на разделе `/home`.

Запускаем node exporter:

```
# systemctl daemon-reload
# systemctl start node_exporter
# systemctl status node_exporter
```

Можно посмотреть как node exporter отдаёт метрики:

```
$ curl -s http://localhost:9100/metrics
# HELP go_gc_duration_seconds A summary of the GC invocation durations.
# TYPE go_gc_duration_seconds summary
go_gc_duration_seconds{quantile="0"} 7.9825e-05
go_gc_duration_seconds{quantile="0.25"} 7.9825e-05
go_gc_duration_seconds{quantile="0.5"} 7.9825e-05
go_gc_duration_seconds{quantile="0.75"} 7.9825e-05
go_gc_duration_seconds{quantile="1"} 7.9825e-05
go_gc_duration_seconds_sum 7.9825e-05
go_gc_duration_seconds_count 1
...
```

Пока не пытайтесь что-то понять в выводе. Отдаёт и ладно.

### Добавление node_exporter в prometheus


Дальше нужно сообщить prometheus что необходимо собирать данные с этого экспортёра. Под каждого экспортёра в конфигурационном файле необходимо создавать подраздел в scrape_configs со следующим содержимым:

```
  - job_name: 'имя_задачи'
    scrape_interval: интервал_сбора_метрик
    static_configs:
      - targets: ['адрес:порт']
```

В данном случае полный конфигурационный файл prometheus будет выглядеть вот так:

```
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:9090']
  - job_name: 'prometheus_node'
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:9100']
```

# Prometheus и Grafana

Prometheus эта система мониторинга состоящая из нескольких компонентов, написанных на языке программирования Golang. Основной компонент Prometheus - это база данных для хранения метрик. Ещё есть компоненты *_exporter для сбора данных с различных сервисов и компонент alertmanager для отправки уведомлений. Кроме того, для отображения метрик в удобном виде принято использовать Grafana.

- Работа с Prometheus не обойдётся без дополнения **Grafana** — с его помощью можно визуализировать полученные данные в виде наглядных графиков, диаграмм и таблиц (dashboard). А также [Alertmanager](https://prometheus.io/docs/alerting/latest/overview/) — программы для настройки уведомлений. Если на целевом объекте появятся проблемы, Alertmanager сможет отправить [письмо на почту](https://www.reg.ru/hosting/mail/), Slack, Hipchat, Pagerduty или Telegram.

- Довольно часто Prometheus настраивают в связке с [Grafana](https://www.dmosk.ru/terminus.php?object=grafana), которая позволяет визуализировать показания наших метрик. В графане для этого есть уже настроенный источник, таким образом, настройка выполняется из коробки.

- Prometheus часто используется в сочетании с другими инструментами, такими как Grafana, для визуализации данных. Grafana позволяет создавать интерактивные панели мониторинга, которые отображают данные из Prometheus.

- Grafana строго говоря не является частью Prometheus’а, но все её ставят и официальная документация рекомендует поступать именно так. Показывает красивые графики. Кучка графиков, собранных на одном экране, называется дашбордом (dashboard). 

- **При установке вручную** Prometheus не будет числиться в списках установленного софта и с точки зрения пакетного менеджера его в системе нет. Зато вы сможете обновлять Prometheus отдельно от пакетов. При ручной установке придётся немного побывать в роли установочного скрипта (который есть в пакете), поэтому, если у вас серьёзные намерения — автоматизируйте установку/обновление через какой-нибудь Ansible. Рекомендую взять за основу готовые роли для [Prometheus](https://github.com/cloudalchemy/ansible-prometheus), [Alertmanager](https://github.com/cloudalchemy/ansible-alertmanager), [Node exporter](https://github.com/cloudalchemy/ansible-node-exporter), [Grafana](https://github.com/cloudalchemy/ansible-grafana).

Prometheus и Grafana - это два популярных инструмента для мониторинга систем и приложений. Prometheus собирает данные о состоянии систем и приложений в виде метрик, а Grafana позволяет визуализировать эти данные в виде графиков, диаграмм и других визуальных представлений.

Использование Prometheus вместе с Grafana обеспечивает следующие преимущества:

- **Эффективность.** Prometheus специализируется на сборе и обработке метрик, а Grafana - на визуализации данных. Благодаря такому разделению труда достигается высокая эффективность мониторинга.
- **Масштабируемость.** Prometheus и Grafana являются масштабируемыми инструментами, которые могут использоваться для мониторинга больших систем.
- **Гибкость.** Prometheus и Grafana имеют гибкую модель данных, которая позволяет собирать широкий спектр метрик и создавать различные визуальные представления данных.

Вот несколько конкретных примеров того, как Prometheus и Grafana могут использоваться вместе:

- **Мониторинг производительности серверов.** Prometheus может использоваться для сбора метрик производительности серверов, таких как нагрузка на процессор, использование памяти и время отклика. Grafana может использоваться для создания графиков, которые отображают эти метрики в течение времени. Это позволяет администраторам серверов отслеживать изменения производительности серверов и выявлять потенциальные проблемы.
- **Мониторинг приложений.** Prometheus может использоваться для сбора метрик производительности приложений, таких как количество ошибок, время отклика и использование памяти. Grafana может использоваться для создания диаграмм, которые отображают эти метрики в сравнении с целевыми значениями. Это позволяет администраторам приложений отслеживать производительность приложений и выявлять потенциальные проблемы.
- **Мониторинг инфраструктуры.** Prometheus может использоваться для сбора метрик производительности компонентов инфраструктуры, таких как сети, хранилища и базы данных. Grafana может использоваться для создания панелей мониторинга, которые отображают данные из Prometheus в сочетании с данными из других источников. Это позволяет администраторам инфраструктуры получить комплексное представление о состоянии всей инфраструктуры.

В целом, использование Prometheus вместе с Grafana является эффективным и масштабируемым решением для мониторинга систем и приложений.